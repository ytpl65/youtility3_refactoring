{% extends "base_form.html" %}

{% block extra_css %}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
{{ sitegrpform.media.css }}
{% endblock extra_css %}

{% block form_title %}
Site Group
{% endblock form_title %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('peoples:sitegroup') }}?template=true" class="pe-3">Site Groups</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Site Group Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
<div class="alert alert-danger" id="nonfield_errors"role="alert" style="display:none">
    <strong>Error</strong> <span></span>
</div>
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->

{% block form %}
<form action="{{ url('peoples:sitegroup') }}" method="post" id="sitegrp_form">
    <input type="hidden" name="pk" id="id_pk"value="{{ sitegrpform.instance.id }}">
    <input type="hidden" name="{{ sitegrpform.ctzoffset.name }}" id = "{{ sitegrpform.ctzoffset.auto_id }}" value="-1">
    {{ sitegrpform.identifier }}

    <div class="row mb-3 gy-3">
        <div class="col-sm-2">
            {{ sitegrpform.groupname.label_tag() }}
        </div>
        <div class="col-sm-6">
            {{ sitegrpform.groupname }}
        </div>
        <div class="col-sm-auto">
            <div class="form-check form-switch form-check-custom form-check-solid">
                {{ sitegrpform.enable }}
                <label for="{{ sitegrpform.enable.id_for_label }}" class="form-check-label">{{ sitegrpform.enable.label }}</label>
            </div>
        </div>
    </div>
</form><br><hr><br>
{% endblock form %}

{% block ajax_page_actions %}
    <div class="form-actions">
        {% if sitegrpform.instance.id %}
        <button type="submit" id="submitTour" form="sitegrp_form" class="btn btn-sm btn-primary btn-hover-scale">
            Update&nbsp;<i class="fas fa-cloud-upload-alt"></i>
        </button>

        <button type="button" onclick="isSiteGrpDeleted({{ sitegrpform.instance.id }})" data-id="{{ sitegrpform.instance.id }}" id="deleteAttd"
            class="btn btn-sm btn-danger btn-hover-scale">
            Delete&nbsp;<i class="fas fa-trash-alt"></i>
        </button>
        {% else %}
        <button type="submit" form="sitegrp_form" class="btn btn-sm btn-primary btn-hover-scale">
            Save&nbsp;<i class="fas fa-cloud-upload-alt"></i>
        </button>
        {% endif %}
    </div>
{% endblock ajax_page_actions %}

{% block extras %}
<div class="row">
<div class="card col-sm-6">
    <div class="card-header">
        <h3 class="card-title">
            All Sites&nbsp;<i class="fas fa-layer-group ch4"></i>
        </h3>
        <div class="card-toolbar me-3">
            <select name="choice" id="custom_butype" style="width:50%" class="form-select form-select-solid"></select>
            <button type="button" id="btn_assign_sites" class="btn btn-sm btn-secondary btn-hover-scale">
                Assign&nbsp;<i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        
        <table id="all_sites" class="display cell-border compact hover nowrap">
        </table>
    </div>
</div>
<div class="card col-sm-6">
    <div class="card-header">
        <h3 class="card-title">
            Assigned Sites &nbsp;<i class="fas ch4 fa-sm fa-paste"></i>
        </h3>
    </div>
    <div class="card-body">
        <table id="assigned_sites"class="display cel-border compact hover nowrap"></table>
    </div>
</div>
</div>
{% endblock extras %}

{% block extra_scripts %}
{{ sitegrpform.media.js }}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script>
    var tabAllsites;
    var tabAssigned_sites;
    var isSitesAssigned;
    var submitUrl;
    var all_sites_response;
    var current_sel_butype = 'CITY';
    var urlname = "{{ url('peoples:sitegroup') }}"

    //populate_buidentifiers
    function populate_buidentifier(resp, id){
        var idfs = resp['idfs']
        for(let i = 0; i<idfs.length; i++){
            if($(id).find("option[value='" + idfs[i]['identifier__tacode'] + "']").length){}
            else{
            var newOption = new Option(idfs[i]['identifier__tacode'], idfs[i]['identifier__tacode'], false, false);
            $(id).append(newOption).trigger('change')
            }
        }
        $(id).val(current_sel_butype);
        $(id).trigger('change');
    }

    //delete ajax request 
	function isSiteGrpDeleted(id){ 
		const params = {url:`${urlname}?action=delete&id=${id}`, 'beforeSend':function () {}}
		fire_ajax_get(params)
		.done((data, status, xhr) => {
			if(!xhr.status === 200){
				return false
			}
			return true
		})
		.fail((xhr, status, error) => {
			show_error_alert('Something went wrong!') //defined in custom.js
			return false
		})
	}

    function loadAssignedSitesIfThereAny(table, id){
        const params = {url:`${urlname}?action=loadSites&id=${id}`, 'beforeSend':function(){}}
        fire_ajax_get(params)
        .done((data, status, xhr) => {
            if(xhr.status === 200){
                console.log(data['assigned_sites'])
				table.rows.add(data['assigned_sites']).draw()
			}
        })
        
    }

    

    $(document).ready(() => {
        //set ctzoffset
        $("#id_ctzoffset").val(-new Date().getTimezoneOffset())

        tabAllsites = $("#all_sites").DataTable({
            ajax:{
                url: "{{ url('peoples:sitegroup') }}?action=allsites",
                data:function ( d ) {
                    d.sel_butype = current_sel_butype;
                    d.fields = ['buid', 'buname', 'parent__buname', 'identifier__tacode'];
                    d.pk = $("#id_pk").val();
                },
                dataSrc:function(resp){
                    console.log(resp, typeof resp)
                    populate_buidentifier(resp, '#custom_butype');
                    return resp['data']
                }
            },
            responsive:true,
            fixedHeader:true,
            ordering: false,
            deferRender: true,
            columns:[
                {data:null, defaultContent: '', orderable:true, className: 'select-checkbox', width: "2%"},
                {data: 'buid', visible:false, orderable:false, defaultContent: ""},
                {data: 'buname', title: "Site Name"},
                {data: "parent__buname", title: "Belongs to"},
                {data: 'identifier__tacode', title: "Type"},
            ],
            select: {
                style:    'multi',
                selector: 'tr'
            },
            dom :  `<'row' <'col-sm-12 d-flex justify-content-start'f> ><'row' <'col-sm-12'rtlp>>`,
            buttons:[]

        })
        $("div.dtToolbar").html(``);
        
        //populate dropdown field
        $("#custom_butype").change(()=>{
            var butype = $("#custom_butype").val()
            if(butype !=  current_sel_butype){
                current_sel_butype = butype
                tabAllsites.ajax.reload()
            }
            
        })
        
        
        
        //populate_buidentifier(tabAllsites, '#custom_butype');

        //ON CLICK GRAB SELECTED AND POPULATE RIGHT TABLE
        $("#btn_assign_sites").click(() => {
            var selected_sites = tabAllsites.rows({'selected':true}).data().toArray()
            tabAssigned_sites.rows().remove().draw()
            tabAssigned_sites.rows.add(selected_sites).draw()
        })

        tabAssigned_sites = $("#assigned_sites").DataTable({
            fixedHeader: true,
            responsive: true,
            dom: "rt",
            order: [[ 1, 'asc' ]],
            columns:[
                {data: 'buid', visible:false, orderable:false, defaultContent: "", render:function(data, type, full, meta){
                    return data == undefined ? "" :data
                }},
                {data: 'buname', title: 'Site Name'},
                {data:function(row, type, val, meta){
                        if(row['13'] != null){
                            return ""
                        }else{
                            return '<a href="#" onClick="return false;"><i class="fas text-dark fa-trash-alt fs-3"></i></a>'
                        }
                    },
                defaultContent: '',
                orderable:false,
                className: "remove text-center",
                targets:12,
                width: "5%"}
            ],
            buttons:[]
        })

        //reduce size of search bar
        
        if("{{ sitegrpform.instance.id }}" != 'None'){
            console.log('checkig...')
            loadAssignedSitesIfThereAny(tabAssigned_sites, "{{ sitegrpform.instance.id }}")
        }
        //ON CLICK TRASH ICON REMOVE ROW
        $('#assigned_sites').on('click', '.remove', function () {
            var row = $(this).parents('tr');
            
            if ($(row).hasClass('child')) {
                table.row($(row).prev('tr')).remove().draw();
            }
            else{
                tabAssigned_sites
                    .row($(this).parents('tr'))
                    .remove()
                .draw();
            }

        });

        //submit form
		$("#sitegrp_form").on('submit', function(e) {
			var form = $(this);
			e.preventDefault()
            if(tabAssigned_sites.data().length){ Swal.fire({
                title: 'Sites Not Assigned!',
                text: "Do you forget to assign sites!",
                icon: 'warning',
                timer:2000
            })}
			
            const params = { url: "{{ url('peoples:sitegroup') }}", modal:false } 
			var payLoad =  {'formData':form.serialize(), csrfmiddlewaretoken: '{{ csrf_token }}', 'assignedSites': JSON.stringify(tabAssigned_sites.rows().data().toArray())}
            var isupdate = $("#id_pk")!=="" ?  false : true
            Swal.fire({
            title: "Submit?",
            text: "This will allocate the selected sites to the Sites group being created!",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Submit'
            }).then((res) => {
                fire_ajax_form_post(params, payLoad)
                .done((data, status, xhr) => { //function to submit post request
                    show_successful_save_alert(update = isupdate)
                })
            })
			
		})

    })

    //delete sitegroup 
	function deleteSiteGroup(elemt){
		var id = $("#id_pk").val()
		show_alert_before_delete('Site Group')
		.then((result) => {
			if(result.isConfirmed){ //delete requested by user
				status = isSiteGrpDeleted(id) //fire's request
				console.log("status ", status)
				if(status){
					show_successful_delete_alert() //defined in customjs
                    location.href = "{{ url('peoples:sitegroup') }}?action=form"

				}else{
					show_error_alert('Something went wrong!');
				}
			}
		})
	}
</script>
{% endblock extra_scripts %}