{% extends "base_form.html" %}


{% block extra_css %}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
{{ sitegrpform.media.css }}
{% endblock extra_css %}


{% block form_title %}
Site Group
{% endblock form_title %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('schedhuler:retrieve_externaltours') }}" class="pe-3">Schedhuled Tours</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">External-Tour Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

{% block form %}
<form action="{{ url('peoples:sitegroup') }}" method="post" id="sitegrp_form">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"> 
    <input type="hidden" name="pk" id="id_pk"value="{{ sitegrpform.instance.id }}">
    <input type="hidden" name="{{ sitegrpform.identifier.name }}" value ="{{ sitegrpform.identifier.value }}", id="{{ sitegrpform.auto_id }}">

    <div class="row mb-3 gy-3">
        <div class="col-sm-2">
            {{ sitegrpform.groupname.label_tag() }}
        </div>
        <div class="col-sm-6">
            {{ sitegrpform.groupname }}
        </div>
        <div class="col-sm-auto">
            <div class="form-check form-switch form-check-custom form-check-solid">
                {{ sitegrpform.enable }}
                <label for="{{ sitegrpform.enable.id_for_label }}" class="form-check-label">{{ sitegrpform.enable.label }}</label>
            </div>
        </div>
    </div>
</form><br><hr><br>
{% endblock form %}


{% block ajax_page_actions %}
    <div class="form-actions">
        {% if sitegrpform.instance.id %}
        <button type="submit" id="submitTour" form="sitegrp_form" class="btn btn-sm btn-primary btn-hover-scale">
            Update&nbsp;<i class="fas fa-cloud-upload-alt"></i>
        </button>

        <button type="button" onclick="deleteMainJob(this)" data-id="{{ sitegrpform.instance.id }}" id="deleteAttd"
            class="btn btn-sm btn-danger btn-hover-scale">
            Delete&nbsp;<i class="fas fa-trash-alt"></i>
        </button>
        {% else %}
        <button type="submit" form="sitegrp_form" class="btn btn-sm btn-primary btn-hover-scale">
            Save&nbsp;<i class="fas fa-cloud-upload-alt"></i>
        </button>
        {% endif %}
    </div>
{% endblock ajax_page_actions %}


{% block extras %}
<div class="row">
<div class="card col-sm-6">
    <div class="card-header">
        <h3 class="card-title">
            All Sites&nbsp;<i class="fas fa-layer-group ch4"></i>
        </h3>
        <div class="card-toolbar">
            <button type="button" id="btn_assign_sites" class="btn btn-sm btn-secondary btn-hover-scale">
                Assign&nbsp;<i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <table id="all_sites" class="display cel-border compact hover nowrap">
        </table>
    </div>
</div>
<div class="card col-sm-6">
    <div class="card-header">
        <h3 class="card-title">
            Assigned Sites &nbsp;<i class="fas ch4 fa-sm fa-paste"></i>
        </h3>
    </div>
    <div class="card-body">
        <table id="assigned_sites"class="display cel-border compact hover nowrap"></table>
    </div>
</div>
</div>
{% endblock extras %}


{% block extra_scripts %}
{{ sitegrpform.media.js }}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script>
    var tabAllsites;
    var tabAssigned_sites;
    var isSitesAssigned;
    var submitUrl;

    $(document).ready(() => {
        tabAllsites = $("#all_sites").DataTable({
            /*ajax:{
                url:"{{ url('peoples:sitegroup') }}?action=allsites",
                data:{
                    'pk':$("#id_pk").val(),
                    'selected_butype':$("#custom_butype").val()
                }
            },*/
            //serverSide:true,
            processing:true,
            responsive:true,
            fixedHeader:true,
            language   : {
                search           : "_INPUT_",
                searchPlaceholder: "Search ..",
				processing:"Getting Data"},
            search    : {return: true},
            lengthMenu: [[40, 50, 60], [40, 50, 60]],
            order:[[1, 'asc']],
            columns:[
                {data:'id', visible:false, orderable:false, defaultContent:""},
                {data:'buname', title:"Site Name"},
                {data:"parent__buname", title:"Belongs to"},
                {data:'butype', title:"Type"}
            ],
            dom :  `<'row' <'col-sm-6'<'dtToolbar'>> <'col-sm-6 d-flex justify-content-end'f>><'row' <'col-sm-12'rtip>>`,
            buttons:[]

        })
        $("div.dtToolbar").html(`<select name="choice" id="custom_butype"><option value="null" selected>------------------</option></select>`);
        
        //ON CLICK GRAB SELECTED AND POPULATE RIGHT TABLE
        $("#btn_assign_sites").click(() => {
            var assigned_sites = tabAllsites.rows({'selected':true}).data().toArray()
            tabAssigned_sites.rows().remove().draw()
            tabAssigned_sites.rows.add(assigned_sites).draw()
        })

        tabAssigned_sites = $("#assigned_sites").DataTable({
            fixedHeader: true,
            responsive: true,
            dom:"rt",
            order: [[ 1, 'asc' ]],
            columns:[
                {data:'id', visible:false, orderable:false},
                {data:'buname', title:'Site Name'},
                {data:function(row, type, val, meta){
                        if(row['13'] != null){
                            return ""
                        }else{
                            return '<a href="#" onClick="return false;"><i class="fas text-dark fa-trash-alt fs-3"></i></a>'
                        }
                    },
                defaultContent:'',
                orderable:false,
                className:"remove text-center",
                targets:12,
                width:"5%"},
                {data:'id', visible:false, orderable:false}
            ],
            buttons:[]
        })

        //ON CLICK TRASH ICON REMOVE ROW
        $('#assigned_sites').on('click', '.remove', function () {
            var row = $(this).parents('tr');
            
            if ($(row).hasClass('child')) {
                table.row($(row).prev('tr')).remove().draw();
            }
            else{
                asgdsites_table
                    .row($(this).parents('tr'))
                    .remove()
                .draw();
            }

        });


        //submit form
		$("#sitegrp_form").on('submit', function(e) {
			var form = $(this);
			e.preventDefault()
            if(!isSitesAssigned){ Swal.fire({
                title:'Sites Not Assigned!',
                text:"Do you forget to assign sites!",
                icon:'warning',
                timer:2000
            })}
			
            const params = { url:urlname, modal:false } 
			var payLoad = form.serialize()//payload for post request
            var isupdate = $("#id_pk")!=="" ?  true : false
			fire_ajax_form_post(params, payLoad)
			.done((data, status, xhr) => { //function to submit post request
				console.log("data ", data)
                //addResultToTable(data.row)
				show_successful_save_alert(isupdate)
			})
		})


    })
</script>
{% endblock extra_scripts %}