{% extends "base_form.html" %}


{% block extra_css %}
{{ schdtourform.media.css }}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" type="text/css">
<link rel="stylesheet" href="{{ static('assets/css/jqCron.css') }}" type="text/css">
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('schedhuler:retrieve_tours') }}" class="pe-3">Schedhuled Tours</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Schedhule Tour Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Schedhule Tour
{% endblock form_title %}
<!------ END FORM TITLE -------->


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
{% if schdtourform.non_field_errors() %}
<div id="non_field_error" class="alert alert-danger" style="width: 73%;">
    {% for error in schdtourform.non_field_errors() %}
    <strong>Error</strong> <span>{{ error }}</span>
    {% endfor %}
    <button type="button" class="btn-close flt-right" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->



{% block form %}
<form action="" method="post" id="id_schdtourform">
    {{ schdtourform.identifier }}
    {{ schdtourform.expirytime }}
    {{ schdtourform.starttime }}
    {{ schdtourform.endtime }}
    {{ schdtourform.ctzoffset }}
    <input type="hidden" name="{{ schdtourform.slno.name }}" id="{{ schdtourform.slno.auto_id }}" value="1">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ schdtourform.jobname.id_for_label }}
                class="required">{{ schdtourform.jobname.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.jobname }}
            {{ schdtourform.jobname.errors }}
        </div>
        <div class="col-md-2">
            <label for={{ schdtourform.jobdesc.id_for_label }}
                class=" required">{{ schdtourform.jobdesc.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.jobdesc }}
            {{ schdtourform.jobdesc.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label class="required">Assign to:</label>
        </div>
        <div class="col-md-4">
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" name={{ schdtourform.assign_to.name }}
                    id="{{ schdtourform.assign_to.auto_id }}1" value="PEOPLE" checked
                    onchange="showHideSelectField('PEOPLE')">
                <label class="form-check-label" for="{{ schdtourform.assign_to.auto_id }}">People</label>
            </div>
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" name={{ schdtourform.assign_to.name }}
                    id="{{ schdtourform.assign_to.auto_id }}2" value="GROUP" onchange="showHideSelectField('GROUP')">
                <label class="form-check-label" for="{{ schdtourform.assign_to.auto_id }}">Group</label>
            </div>
        </div>

        <!-- ASSIGN TO PEOPLE --->
        <div class="col-md-2 people">
            <label for={{ schdtourform.people.id_for_label }} class="">{{ schdtourform.people.label }}:</label>
        </div>
        <div class="col-md-4 people">
            {{ schdtourform.people }}
            {{ schdtourform.people.errors }}
        </div>
        <!-- ASSIGN TO GROUP --->
        <div class="col-md-2 pgroup">
            <label for={{ schdtourform.pgroup.id_for_label }} class="">{{ schdtourform.pgroup.label }}:</label>
        </div>
        <div class="col-md-4 pgroup">
            {{ schdtourform.pgroup }}
            {{ schdtourform.pgroup.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ schdtourform.planduration.id_for_label }}
                class="required">{{ schdtourform.planduration.label }}:</label>
        </div>
        <div class="col-md-2">
            {{ schdtourform.freq_duration }}
            {{ schdtourform.freq_duration.errors }}
        </div>
        <div class="col-md-2">
            {{ schdtourform.planduration }}
            {{ schdtourform.planduration.errors }}
        </div>

        <div class="col-md-2">
            <label for={{ schdtourform.gracetime.id_for_label }}
                class="required">{{ schdtourform.gracetime.label }}:</label>
        </div>
        <div class="col-md-2">
            {{ schdtourform.freq_duration2 }}
            {{ schdtourform.freq_duration2.errors }}
        </div>
        <div class="col-md-2">
            {{ schdtourform.gracetime }}
            {{ schdtourform.gracetime.errors }}
        </div>
    </div>

    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for="{{ schdtourform.priority.id_for_label }}"
                class="required">{{ schdtourform.priority.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.priority }}
            {{ schdtourform.priority.errors }}
        </div>

        <div class="col-md-2">
            <label for="{{ schdtourform.cron.id_for_label }}" class="required">{{ schdtourform.cron.label }}:</label>
        </div>
        <div class="col-md-4 d-flex">
            <input type="text" name="{{ schdtourform.cron.name }}" value="{{ schdtourform.cron.value() }}" id="id_cron" readonly required class="form-control" maxlength="250" />
            <a  class="btn btn-circle btn-icon-only btn-default " id="cron_selector">
                <i class="fa fa-clock fs-4 text-primary" aria-hidden="true"></i>
            </a>
            {{ schdtourform.cron.errors }}
        </div>
    </div>

    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for="{{ schdtourform.ticket_category.id_for_label }}"
                class="required">{{ schdtourform.ticket_category.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.ticket_category }}
            {{ schdtourform.ticket_category.errors }}
        </div>

        <div class="col-md-2">
            <label for="{{ schdtourform.from_date.id_for_label }}"
                class="required">{{ schdtourform.from_date.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.from_date }}
            {{ schdtourform.from_date.errors }}
        </div>
    </div>


    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for="{{ schdtourform.scantype.id_for_label }}"
                class="required">{{ schdtourform.scantype.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.scantype }}
            {{ schdtourform.scantype.errors }}
        </div>

        <div class="col-md-2">
            <label for="{{ schdtourform.upto_date.id_for_label }}"
                class="required">{{ schdtourform.upto_date.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtourform.upto_date }}
            {{ schdtourform.upto_date.errors }}
        </div>
    </div>
</form>
{{ schdtourform.identifier }}
{{ schdtourform.starttime }}
{{ schdtourform.endtime }}
{{ schdtourform.expirytime }}
<br><br>
<div class="card card-bordered card-flush shadow-sm">
    <div class="card-header  collapsible cursor-pointer rotate" data-bs-toggle="collapse" data-bs-target="#kt_docs_card_collapsible">
        <h5 class="card-title modal-heading">
            Assign Chechpoint and Checklist &nbsp;<i class="fas fs-3 text-primary fa-map-marker-alt"></i>
        </h5>
    </div>
    <div id="kt_docs_card_collapsible" class="collapse show">
        <div class="card-body">
            <form action="" id="createchildjob_form" method="post">
                <div class="row mb-3 gy-3">
                    <div class="col-md-1">
                        <label for="{{ childtour_form.asset.id_for_label }}"
                            class="required">{{ childtour_form.asset.label }}:</label>
                    </div>
                    <div class="col-md-5">
                        {{ childtour_form.asset }}
                        {{ childtour_form.asset.errors }}
                    </div>
                    
                    <div class="col-md-1">
                        <label for="{{ childtour_form.qset.id_for_label }}"
                            class="required">{{ childtour_form.qset.label }}:</label>
                    </div>

                    <div class="col-md-5">
                        {{ childtour_form.qset }}
                        {{ childtour_form.qset.errors }}
                    </div>
                </div>
                <div class="row mb-3 gy-3">
                    <div class="col-md-1">
                        <label for="{{ childtour_form.expirytime.id_for_label }}"
                            class="required">{{ childtour_form.expirytime.label }}:</label>
                    </div>
                    {# <div class="col-md-2">
                        {{ childtour_form.timeIn }}
                    </div> #}
                    <div class="col-md-3">
                        {{ childtour_form.expirytime }}
                    </div>
                </div>

                <!-- ADD/DELETE/RESET BUTTONS OF MIDDLE FORM -->
                <div class="d-flex justify-content-end">
                    <button type="submit" id="addQuestion" form="createchildjob_form"
                        class="btn btn-sm btn-success me-2 btn-hover-scale">
                        Add&nbsp;<i class="fa fa-plus" aria-hidden="true"></i>
                    </button>

                    <button type="button" id="resetMiddleForm" style="display:none;"
                        class="btn ms-2 btn-sm btn-primary btn-hover-scale">
                        Reset&nbsp;<i class="fas fa-times"></i>
                    </button>
                </div>

                <hr>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title modal-heading">Checpoint and Checklist Mapping</h4>
                        <div class="table-responsive">
                            <table id="checkpoints_tour" class="display compact cell-border" style="width:100%">
                                <thead>
                                    <th>#</th>
                                    <th>CheckpointId</th>
                                    <th>Checkpoint</th>
                                    <th>ChecklistId</th>
                                    <th>Checklist</th>
                                    <th>Expiry time (Min)</th>
                                </thead>
                                <tbody>
                                    {% if checkpoints is defined %}
                                    {% for checkpoint in checkpoints %}
                                    <tr>
                                        <td>{{ checkpoint['slno'] }}</td>
                                        <td>{{ checkpoint['asset__id'] }}</td>
                                        <td>{{ checkpoint['asset__assetname'] }}</td>
                                        <td>{{ checkpoint['qset__id'] }}</td>
                                        <td>{{ checkpoint['qset__qset_name'] }}</td>
                                        <td>{{ checkpoint['expirytime'] }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>
{% endblock form %}


{% block popup_alerts %}
    {% call general_popup(popup_id = "cron_scheduler", title="Cron Scheduler", modal_size='modal-lg') %}
        <div class="modal-body">

            <div class="row">
                <div class="col-md-12">
                    <div class="portlet-body form">
                        <div class="jqCronEditor"></div><br><br>
                        <div>
                            <p>Cron Value : <input type="text" id="cron_selected_val" readonly class="form-control input-inline input-large"/></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="btnSetCron"  class="btn btn-sm  btn-success rounded-1">Set</button>
        </div>
    {% endcall %}
{% endblock popup_alerts %}



{% block ajax_page_actions %}
<div class="form-actions">
    {% if schdtourform.instance.id %}
    <button type="button" id="runScheduler"  class="btn btn-sm btn-info btn-hover-scale">
        Run Scheduler&nbsp;<i class="far fa-clock"></i>
    </button>
    
    <button type="submit" id="submitTour" form="id_schdtourform" class="btn btn-sm btn-primary btn-hover-scale">
        Update Tour&nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>

    <button type="button" onclick="deleteMainJob(this)" data-id="{{ schdtourform.instance.id }}" id="deleteAttd"
        class="btn btn-sm btn-danger btn-hover-scale">
        Delete&nbsp;<i class="fas fa-trash-alt"></i>
    </button>
    {% else %}
    <button type="submit" form="id_schdtourform" class="btn btn-sm btn-primary btn-hover-scale">
        Save Tour&nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>
    {% endif %}
</div>
{% endblock ajax_page_actions %}


{% block extra_scripts %}
{{ schdtourform.media.js }}
<script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
<script src="{{ static('assets/js/jqCron.js') }}"></script>
<script src="{{ static('assets/js/jqCron.en.js') }}"></script>
<script>
    var table = null;
    const createUrl = "{{ url('schedhuler:create_tour') }}"
    // add classes to label tags.
    $('label').removeClass("col-form-label col-md-2 col-sm-2 text-sm-right")

    function showHideSelectField(val) {
        if (val == "PEOPLE") {
            //$("#aatopdiv").show();
            $(".people").show();
            $(".pgroup").hide();
        } else {
            //$("#aatopdiv").hide();
            $(".pgroup").show();
            $(".people").hide();
        }
    }
    //return selected value of a field
    function getSelectedValue(id) {
        var data = $(id).select2('data')[0]
        if (typeof data !== 'undefined') {
            return data.text
        }
        return "NONE"
    }

    //collect checkpoints data for insertion in 
    //table -> "Checpoint and Checklist Mapping"
    function getCheckpointFormdata() {
        console.log("Getting question formdata ")
        var formData = {}
        formData['slno'] = $("#createchildjob_form #id_slno").val()
        formData['qset_id'] = $("#createchildjob_form #id_qset").val()
        formData['asset_id'] = $("#createchildjob_form #id_asset").val()
        formData['expirytime'] = $("#createchildjob_form #id_expirytime").val()
        formData['qset'] = getSelectedValue("#createchildjob_form #id_qset")
        formData['asset'] = getSelectedValue("#createchildjob_form #id_asset")

        console.log("formData", formData)
        return formData
    }

    function resetForm() {
        $("#createchildjob_form #id_expirytime").val("")
        $("#createchildjob_form #id_qset, #createchildjob_form #id_asset").val(null).trigger('change');
    }

    function processValidForm() {
        data = getCheckpointFormdata();
        rowdata = [-1, data.asset_id, data.asset, data.qset_id, data.qset, data.expirytime]
        table.row('.toupdate').remove().draw(false);
        isduplicate = check_for_duplicates(table, rowdata)
        if (!isduplicate) {
            table.row.add(rowdata).draw()
            resetForm()
            //adjustForm(table)
            $("#deleteCheckpoint").hide();
        } else {
            let heading = "Duplicate Record"
            let msg = "This type ('Checkpoint and QuestionSet') record is already exist"
            show_error_alert(msg, heading)
        }
    }

    //checks duplicates before inserting into 
    //datatable -> "List of Assigned Questions" 
    function check_for_duplicates(table, dataToInsert) {
        console.log("check_for_duplicates [start]")
        var tableData = table.rows().data().toArray();
        console.log(tableData)
        for (var row in tableData) {
            if (tableData[row][1] === dataToInsert[1]) {
                return true
            }
        }
        return false
    }


    function checkTourWoCheckpoints(table) {

        rows = table.rows().data().toArray()
        return rows.length < 1 //returns true if qset w/o questions else false
    }

    function adjustSlnoInTable() {
        console.log("rows adjsuting")
        var tableData = table.rows().data().toArray();
        table.rows().remove().draw();
        var seq = 0
        for (var row in tableData) {
            seq++
            tableData[row][0] = seq
        }
        table.rows.add(tableData).draw()
        console.log("rows adjusted")
    }

    function update_checkpoint_form(data, fortable = false) {
        $("#createchildjob_form #id_slno").val(parseInt(data[0]))
        $("#createchildjob_form #id_asset").val(data[1]).change()
        $("#createchildjob_form #id_qset").val(data[3]).change()
        $("#createchildjob_form #id_expirytime").val(data[5])
        console.log("while updating", data.id_alertbelow, data.id_alertabove)
        $('#resetMiddleForm').show()
        

    }

    function deleteCheckpointRequest(checpointid, checklistid, job) {
        var deleted = false
        const params = {
            'url': `{{ url('schedhuler:delete_checkpointTour') }}?checkpointid=${checpointid}&checklistid=${checklistid}&job=${job}&datasource=job`,
            'beforeSend': function () {}
        }
        fire_ajax_get(params)
            .done((data, status, xhr) => {
                show_successful_delete_alert()
                deleted = true
            })
            .fail((xhr, status, error) => {
                show_error_alert('Something went wrong!')
            })
        return deleted
    }
    //alerts user for saving the form without checkpoints
    function tourWoCheckpointsSetAlert() {
        console.log("fired already")
        return show_error_alert(
            'You have not submitted any Checkpoints yet, for this Tour.',
            title = "Tour Without Checkpoints"
        )
    }

    function addRemoveClass(ele){
        if ($(ele).hasClass('selected')) {
            $(ele).removeClass('selected');
        } else {
            table.$('tr.selected').removeClass('selected');
            $(ele).addClass('selected');
        }
    }

    //delete ajax request 
	function isMainJobDeleted(id){ 
		console.log("id ", id)
		const params = {url:`${urlname}?action=delete&id=${id}`}
		fire_ajax_get(params)
		.done((data, status, xhr) => {
			if(!xhr.status === 200){
				return false
			}
			return true
		})
		.fail((xhr, status, error) => {
			show_error_alert('Something went wrong!') //defined in custom.js
			return false
		})
	}

    function deleteMainJob(ele){
        var id = $(ele).attr('data-id')
        show_alert_before_delete('Guard Tour')
		.then((result) => {
			if(result.isConfirmed){ //delete requested by user
				status = isMainJobDeleted(id) //fire's request
				console.log("status ", status)
				if(status){
					show_successful_delete_alert() //defined in customjs
				}else{
					show_error_alert(xhr.responseJSON.errors);
				}
			}
		})
    }


    $(document).ready(() => {
        //SET CTZOFFSET ON LOAD
        var offset = new Date().getTimezoneOffset();
        $("#id_ctzoffset").val(offset)
        console.log($("#id_ctzoffset").val())
        //Checkpoints & Checklist Mapping 
        // Datatable configuration 
        table = $('#checkpoints_tour').DataTable({
            responsive: true,
            fixedHeader: true,
            paging: false,
            lengthChange: false,
            order: [
                [0, "asc"]
            ],
            scrollCollapse: true,
            sDom: "",
            ordering: true,
            columnDefs: [{
                    "width": "5%",
                    "targets": [0]
                },
                {
                    "width": "9%",
                    "targets": [5]
                },
                {
                    orderable: false,
                    targets: [1, 2, 4,5]
                },
                {
                    "targets": [1, 3],
                    "visible": false,
                    "searchable": false
                },
            ]
        })

        //hide the delete button when instance is not saved yet.
        if ('{{schdtourform.instance.id}}' == ('None' || "")) {
            $("#btn_del").hide()
        }
        //toggle people and pgroup field based on radio button value
        if ('{{schdtourform.instance.id}}' == ('None' || "")) {
            showHideSelectField('PEOPLE')
        }else{
            var assignto = '{{schdtourform.instance.people}}' == ('None' || "") ? "GROUP" :"PEOPLE"
            showHideSelectField(assignto)
        }
        //ADD CALENDER TO DATE FIELDS WITH FLAT-PICKR PLUGIN
        $("#id_from_date, #id_upto_date").flatpickr({
            enableTime: true,
            time_24hr: true,
            dateFormat: 'd-M-Y H:S'
        })

        $("#resetMiddleForm").click(() => {
            resetForm();
            $(this).hide()
        })

        //on submitting the questionset-blng form populate the table
        // "Checkpoint & Checklist Mapping"
        $('#createchildjob_form').on('submit', function (e) {
            e.preventDefault()
            processValidForm()
            adjustSlnoInTable()
        });

        //on click on table row populate the above question form for update
        $("#checkpoints_tour tbody").on("click", 'tr', function () {
            if (!$(this).children().hasClass("dataTables_empty")) {
                show_alert_before_update("Checkpoint").then((result) => {
                    if (result.isConfirmed) {
                        addRemoveClass(this)
                        console.log(table.row('.selected').data())
                        update_checkpoint_form(table.row('.selected').data(), fortable =
                            false)
                        $(this).addClass('toupdate');
                        $("#deleteQuestion").show()
                    }else if(result.isDenied){
                        //delete checkpoint request
                        addRemoveClass(this)
                        const isDeleted = false
                        console.log("delete initiated")
                        if ('{{ schdtourform.instance.id }}' !== ('None' || "")) {
                            data = table.row('.selected').data()
                            console.log(data)
                            isDeleted = deleteCheckpointRequest(data[1], data[3], "{{ schdtourform.instance.id }}")
                        }
                        if(isDeleted){
                            table.row('.selected').remove().draw();
                            adjustSlnoInTable()
                        }
                    }
                })
            }
        })

        $("#id_schdtourform").on('submit', function (e) {
            if (checkTourWoCheckpoints(table)) {
                e.preventDefault();
                tourWoCheckpointsSetAlert()
            } else {
                var form = $(this);
                e.preventDefault()
                const params = {
                    url: createUrl,
                    modal: false
                } //checklist view
                const formtype = '{{schdtourform.instance.id}}' == 'None' ? "create" : "update" //form-type (create/update)
                const id = '{{schdtourform.instance.id}}' //form instance id
                var payLoad = {
                    formData: form.serialize(),
                    asssigned_checkpoints: JSON.stringify(table.rows().data().toArray()),
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                } //payload for post request
                if (formtype === 'update') {
                    var newPayLoad = {
                        ...payLoad,
                        'pk': id
                    }
                    payLoad = newPayLoad
                }
                submit_form_alert().then((res) => {
                    if(res.isConfirmed){
                        fire_ajax_form_post(params, payLoad)
                        .done((data, status, xhr) => { //function to submit post request
                            Swal.fire(
                                `Guard Tour saved`,
                                `Guard Tour with this name <strong>${data.jobname}</strong> has been saved successfully`,
                                'success'
                            ).then(function () {
                                window.location.replace(data.url);
                            })
                        })
                        .fail((xhr, status, error) => {
                            console.log(xhr)
                            show_error_alert(xhr.responseJSON.errors, "Failed to save!")
                        })
                    }
                    
                })
                
            }
        })

        $("#runScheduler").click(function() {
            Swal.fire({
                title:"Are you sure?",
                text:"Run Tour Scheduler, you won't be able to revert this!",
                icon:"warning",
                showCancelButton:true,
                confirmButtonText:"Schedule it!"
            }).then((result) => {
                if(result.isConfirmed){
                    const params = {url:"{{ url('schedhuler:runJob') }}"}
                    var payLoad = {job:'{{ schdtourform.instance.id }}', csrfmiddlewaretoken: '{{ csrf_token }}'}
                    fire_ajax_form_post(params, payLoad)
                    .done((data, status, xhr) => {
                        Swal.fire({
                            showConfirmButton:false,
                            timer:1500,
                            icon:'success',
                            title:"Tour schedhuled successfully!"
                        })
                    })
                    .fail((xhr, status, error) => {
                        Swal.fire({
                            showConfirmButton:false,
                            icon:"error",
                            timer:1500,
                            title:"Failed to schedhule successfully!"
                        })
                    })
                }
            })
        })
        
        //after cron set hide the modal
        $("#btnSetCron").click(function(){
            var cron_val= $("#cron_selected_val").val();
            $("#id_cron").val(cron_val);
            $('#cron_scheduler').modal('hide');
        });

        //show cron editor on bootstrap modal
        $("#cron_selector").click(function(){
            var old_cron_val= $("#id_cron").val();
            $('#cron_selected_val').val(old_cron_val);
            if(old_cron_val == '') old_cron_val="* * * * *";
            console.log("@@@@",old_cron_val);
            if(old_cron_val != ''){
                $(function(){
                    $('.jqCronEditor').html('');
                    $('.jqCronEditor').jqCron({
                        enabled_minute: true,
                        multiple_dom: true,
                        multiple_month: true,
                        multiple_mins: true,
                        multiple_dow: true,
                        multiple_time_hours: true,
                        multiple_time_minutes: true,
                        default_period: 'week',
                        default_value: old_cron_val,
                        no_reset_button: false,
                        lang: 'en',
                        numeric_zero_pad: true,
                        bind_to: $('#cron_selected_val'),
                        bind_method: {
                            set: function($element, value) {
                            $element.val(value);
                            }
                        }
                    });
                });
            }
            $('#cron_scheduler').modal('show');
        });

        if(!$("#checkpoints_tour tbody tr").hasClass("selected")){
            resetForm()
        }
    })
</script>
{% endblock extra_scripts %}