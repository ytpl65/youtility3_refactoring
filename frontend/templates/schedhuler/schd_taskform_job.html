{% extends "base_form.html" %}


{% block extra_css %}
{{ schdtaskform.media.css }}
<link rel="stylesheet" href="{{ static('assets/css/jqCron.css') }}" type="text/css">
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('schedhuler:retrieve_tasks') }}" class="pe-3">Schedhuled Tasks</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Schedhule Task Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Schedhule Task
{% endblock form_title %}
<!------ END FORM TITLE -------->


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
    {% if schdtaskform.non_field_errors() %}
    <div id="non_field_error" class="alert alert-danger" style="width: 73%;">
        {% for error in schdtaskform.non_field_errors()[::-1] %}
        <strong>Error</strong> <span>{{ error }}</span>
        {% endfor %}
        <button type="button" class="btn-close flt-right" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->


{% block form %}
<form action="{{ url('schedhuler:create_task') }}" method="post" id="schdtaskform">
        {{ schdtaskform.identifier }}
        {{ schdtaskform.starttime }}
        {{ schdtaskform.frequency }}
        {{ schdtaskform.endtime }}
        {{ schdtaskform.ctzoffset }}

    <input type="hidden" name="{{ schdtaskform.slno.name }}" id="{{ schdtaskform.slno.auto_id }}" value="1">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="row gy-3">
        
        <!--JOBNAME-->
        <div class="col-md-2">
            <label for={{ schdtaskform.jobname.id_for_label }}
                class="required">{{ schdtaskform.jobname.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.jobname }}
            {{ schdtaskform.jobname.errors }}
        </div>
        
        <!--PLANDURATION-->
        <div class="col-md-2">
            <label for={{ schdtaskform.planduration.id_for_label }}
                class=" required">{{ schdtaskform.planduration.label }}:</label>
        </div>
        <div class="col-md-2">
            {{ schdtaskform.planduration_type }}
        </div>
        <div class="col-md-2">
            {{ schdtaskform.planduration }}
            {{ schdtaskform.planduration.errors }}
        </div>

        
        <!--JOBDESCRIPTION-->
        <div class="col-md-2">
            <label for={{ schdtaskform.jobdesc.id_for_label }}
                class="">{{ schdtaskform.jobdesc.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.jobdesc }}
            {{ schdtaskform.jobdesc.errors }}
        </div>
        
        <!--GRACETIME-->
        <div class="col-md-2">
            <label for={{ schdtaskform.gracetime.id_for_label }}
                class=" required">{{ schdtaskform.gracetime.label }}:</label>
        </div>
        <div class="col-md-2">
            {{ schdtaskform.gracetime_type }}
        </div>
        <div class="col-md-2">
            {{ schdtaskform.gracetime }}
            {{ schdtaskform.gracetime.errors }}
        </div>

        
        <!--ASSET-->
        <div class="col-md-2">
            <label for={{ schdtaskform.assetid.id_for_label }}
                class="required">{{ schdtaskform.assetid.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.assetid }}
            {{ schdtaskform.assetid.errors }}
        </div>
        
        <!--EXPIRYTIME-->
        <div class="col-md-2">
            <label for={{ schdtaskform.expirytime.id_for_label }}
                class=" required">{{ schdtaskform.expirytime.label }}:</label>
        </div>
        <div class="col-md-2">
            {{ schdtaskform.expirytime_type }}
        </div>
        <div class="col-md-2">
            {{ schdtaskform.expirytime }}
            {{ schdtaskform.expirytime.errors }}
        </div>
        
        <!--QUESTIONSET-->
        <div class="col-md-2">
            <label for={{ schdtaskform.qsetid.id_for_label }}
                class=" required">{{ schdtaskform.qsetid.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.qsetid }}
            {{ schdtaskform.qsetid.errors }}
        </div>
        
        <!--CRON-->
        <div class="col-md-2">
            <label for="{{ schdtaskform.cron.id_for_label }}" class="required">{{ schdtaskform.cron.label }}:</label>
        </div>
        <div class="col-md-4 d-flex">
            <input type="text" name="{{ schdtaskform.cron.name }}" value="{{ schdtaskform.cron.value() }}" id="id_cron"
             readonly required class="form-control form-control-solid" maxlength="250" />
            <a  class="btn btn-circle btn-icon-only btn-default " id="cron_selector">
                <i class="fa fa-clock fs-4 text-primary" aria-hidden="true"></i>
            </a>
            {{ schdtaskform.cron.errors }}
        </div>
        
        <!--ASSIGNTO-->
        <div class="col-md-2">
            <label for={{ schdtaskform.assign_to.id_for_label }}
                class="required">{{ schdtaskform.assign_to.label }}:</label>
        </div>
        <div class="col-md-4">
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" name={{ schdtaskform.assign_to.name }}
                    id="{{ schdtaskform.assign_to.auto_id }}1" value="PEOPLE" checked
                    onchange="showHideSelectField('PEOPLE')">
                <label class="form-check-label" for="{{ schdtaskform.assign_to.auto_id }}">People</label>
            </div>
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" name={{ schdtaskform.assign_to.name }}
                    id="{{ schdtaskform.assign_to.auto_id }}2" value="GROUP" onchange="showHideSelectField('GROUP')">
                <label class="form-check-label" for="{{ schdtaskform.assign_to.auto_id }}">Group</label>
            </div>
        </div>
        
        
        <!--FROM DATE-->
        <div class="col-md-2">
            <label for={{ schdtaskform.from_date.id_for_label }}
                class=" required">{{ schdtaskform.from_date.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.from_date }}
            {{ schdtaskform.from_date.errors }}
        </div>
        

        <!--PEOPLEID-->
        <div class="col-md-2 peopleid">
            <label for={{ schdtaskform.peopleid.id_for_label }}
                class="required">{{ schdtaskform.peopleid.label }}:</label>
        </div>
        <div class="col-md-4 peopleid">
            {{ schdtaskform.peopleid }}
            {{ schdtaskform.peopleid.errors }}
        </div>

        <!-- ASSIGN TO GROUP --->
        <div class="col-md-2 groupid">
            <label for={{ schdtaskform.groupid.id_for_label }} class="">{{ schdtaskform.groupid.label }}:</label>
        </div>
        <div class="col-md-4 groupid">
            {{ schdtaskform.groupid }}
            {{ schdtaskform.groupid.errors }}
        </div>
        
        
        <!--UPTO DATE-->
        <div class="col-md-2">
            <label for={{ schdtaskform.upto_date.id_for_label }}
                class=" required">{{ schdtaskform.upto_date.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.upto_date }}
            {{ schdtaskform.upto_date.errors }}
        </div>
        

        <!--PRIORITY-->
        <div class="col-md-2">
            <label for={{ schdtaskform.priority.id_for_label }}
                class="required">{{ schdtaskform.priority.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.priority }}
            {{ schdtaskform.priority.errors }}
        </div>
        
        <!--SCANTYPE-->
        <div class="col-md-2">
            <label for={{ schdtaskform.scantype.id_for_label }}
                class="required">{{ schdtaskform.scantype.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.scantype }}
            {{ schdtaskform.scantype.errors }}
        </div>
        
        <!--TICKET CATEGORY-->
        <div class="col-md-2">
            <label for={{ schdtaskform.ticket_category.id_for_label }}
                class=" required">{{ schdtaskform.ticket_category.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ schdtaskform.ticket_category }}
            {{ schdtaskform.ticket_category.errors }}
        </div>
    </div>
</form><br><br>

{% endblock form %}


{% block popup_alerts %}
    {% call general_popup(popup_id = "cron_scheduler", title="Cron Scheduler <i class='fas fa-clock'></i>", modal_size='modal-lg') %}
        <div class="modal-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet-body form">
                        <div class="jqCronEditor"></div><br><br>
                        <div>
                            <p>Cron Value : <input type="text" id="cron_selected_val" readonly class="form-control input-inline input-large"/></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="btnSetCron"  class="btn btn-sm  btn-success rounded-1">Set</button>
        </div>
    {% endcall %}
{% endblock popup_alerts %}


{% block ajax_page_actions %}
<div class="form-actions">
    {% if schdtaskform.instance.id %}
    <button type="button" id="runScheduler"  class="btn btn-sm btn-info btn-hover-scale">
        Run Scheduler&nbsp;<i class="far fa-clock"></i>
    </button>
    
    <button type="submit" id="submitTour" form="schdtaskform" class="btn btn-sm btn-primary btn-hover-scale">
        Update Tour&nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>

    <button type="button" onclick="deleteMainJob(this)" data-id="{{ schdtaskform.instance.id }}" id="deleteAttd"
        class="btn btn-sm btn-danger btn-hover-scale">
        Delete&nbsp;<i class="fas fa-trash-alt"></i>
    </button>
    {% else %}
    <button type="submit" form="schdtaskform" class="btn btn-sm btn-primary btn-hover-scale">
        Save&nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>
    {% endif %}
</div>
{% endblock ajax_page_actions %}


{% block extra_scripts %}
{{ schdtaskform.media.js }}
<script src="{{ static('assets/js/jqCron.js') }}"></script>
<script src="{{ static('assets/js/jqCron.en.js') }}"></script>

<script>
    // add classes to label tags.
    $('label').removeClass("col-form-label col-md-2 col-sm-2 text-sm-right")

    function showHideSelectField(val) {
        if (val == "PEOPLE") {
            //$("#aatopdiv").show();
            $(".peopleid").show();
            $(".groupid").hide();
        } else {
            //$("#aatopdiv").hide();
            $(".groupid").show();
            $(".peopleid").hide();
        }
    }

    $(document).ready(function(){
        //toggle peopleid and groupid field based on radio button value
        if ('{{schdtaskform.instance.id}}' == ('None' || "")) {
            showHideSelectField('PEOPLE')
        }else{
            var assignto = '{{schdtaskform.instance.peopleid}}' == ('None' || "") ? "GROUP" :"PEOPLE"
            showHideSelectField(assignto)
        }

        //hide the delete button when instance is not saved yet.
        if ('{{schdtaskform.instance.id}}' == ('None' || "")) {
            $("#btn_del").hide()
        }

        //ADD CALENDER TO DATE FIELDS WITH FLAT-PICKR PLUGIN
        $("#id_from_date, #id_upto_date").flatpickr({
            enableTime: true,
            time_24hr: true,
            dateFormat: 'd-M-Y H:S'
        })

        //after cron set hide the modal
        $("#btnSetCron").click(function(){
            var cron_val= $("#cron_selected_val").val();
            $("#id_cron").val(cron_val);
            $('#cron_scheduler').modal('hide');
        });

        //show cron editor on bootstrap modal
        $("#cron_selector").click(function(){
            var old_cron_val= $("#id_cron").val();
            $('#cron_selected_val').val(old_cron_val);
            if(old_cron_val == '') old_cron_val="* * * * *";
            console.log("@@@@",old_cron_val);
            if(old_cron_val != ''){
                $(function(){
                    $('.jqCronEditor').html('');
                    $('.jqCronEditor').jqCron({
                        enabled_minute        : true,
                        multiple_dom          : true,
                        multiple_month        : true,
                        multiple_mins         : true,
                        multiple_dow          : true,
                        multiple_time_hours   : true,
                        multiple_time_minutes : true,
                        default_period        : 'week',
                        default_value         : old_cron_val,
                        no_reset_button       : false,
                        lang                  : 'en',
                        numeric_zero_pad      : true,
                        bind_to               : $('#cron_selected_val'),
                        bind_method: {
                            set: function($element, value) {
                            $element.val(value);
                            }
                        }
                    });
                });
            }
            $('#cron_scheduler').modal('show');
        });


        //on submit form post request
        $("#schdtaskform").submit((e) => {
            e.preventDefault()
            var form = $(this);
            const params   = { url: $(form).attr("action"), modal: false }
            const formtype = '{{schdtaskform.instance.id}}' == 'None' ? "create" : "update"         
            const id       = '{{schdtaskform.instance.id}}'                                          
            var   payLoad  = { formData: $("#schdtaskform").serialize(),csrfmiddlewaretoken: '{{ csrf_token }}' }
            
            if (formtype === 'update') {
                var newPayLoad = { ...payLoad,'pk': id }
                    payLoad    = newPayLoad
            }
            submit_form_alert().then((res) => {
                if(res.isConfirmed){
                    fire_ajax_form_post(params, payLoad)
                    .done((data, status, xhr) => {
                        Swal.fire(
                            `Task Form saved`,
                            `Task Form with this name <strong>${data.jobname}</strong> has been saved successfully`,
                            'success'
                        ).then(function () {
                            window.location.replace(data.url);
                        })
                    })
                    .fail((xhr, status, error) => {
                        console.log(xhr)
                        if(!typeof(xhr.responseJSON.errors) === 'object'){
                            show_error_alert(xhr.responseJSON.errors, "Failed to save!")
                        }else{}
                        
                    })
                }
            })
        })

        //RUN-JOB SCHEDULER DEFINITION
        $("#runScheduler").click(function() {
            Swal.fire({
                title:"Are you sure?",
                text:"Run Task Scheduler, you won't be able to revert this!",
                icon:"warning",
                showCancelButton:true,
                confirmButtonText:"Schedule it!"
            }).then((result) => {
                if(result.isConfirmed){
                    const params = {url:"{{ url('schedhuler:runJob') }}"}
                    var payLoad = {jobid:'{{ schdtaskform.instance.id }}',
                    csrfmiddlewaretoken: '{{ csrf_token }}'}
                    fire_ajax_form_post(params, payLoad)
                    .done((data, status, xhr) => {
                        Swal.fire({
                            showConfirmButton:false,
                            timer:1500,
                            icon:'success',
                            title:"Task schedhuled successfully!"
                        })
                        $('#lblIsRTour').html('No');
                    })
                    .fail((xhr, status, error) => {
                        Swal.fire({
                            showConfirmButton:false,
                            icon:"error",
                            timer:1500,
                            title:"Failed to schedhule!"
                        })
                    })
                }
            })
        })
    })
</script>
{% endblock extra_scripts %}