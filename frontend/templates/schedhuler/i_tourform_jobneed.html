{% extends "globals/base_form.html" %}

{% block extra_css %}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
<link  href="{{ static('assets/plugins/custom/Editor-2.0.8/css/editor.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
{{ internaltourform.media.css }}
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('schedhuler:retrieve_internaltours') }}" class="pe-3">Tours</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Tour Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Internal Tour
{% endblock form_title %}
<!------ END FORM TITLE -------->


{% block breadcumbactions %}
<button class="btn btn-secondary dropdown-toggle" type="button" id="id_actions" data-bs-toggle="dropdown" aria-expanded="false">
    Actions
</button>
<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
    <li><a class="dropdown-item" href="#" id="id_attachment"><i class="fas text-white fa-paperclip"></i> &nbsp;Attachment</a></li>
</ul>
{% endblock breadcumbactions %}



{% block form %}
<form action="" method="post" id="internaltourform">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <input type="hidden" name="{{ internaltourform.ctzoffset.name }}" id = "{{ internaltourform.ctzoffset.auto_id }}" value="-1">
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ internaltourform.jobdesc.id_for_label }}
                class="required">{{ internaltourform.jobdesc.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.jobdesc }}
            {{ internaltourform.jobdesc.errors }}
        </div>
        <div class="col-md-2">
            <label for={{ internaltourform.plandatetime.id_for_label }}
                class="required">{{ internaltourform.plandatetime.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.plandatetime }}
            {{ internaltourform.plandatetime.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label class="required">Assign to:</label>
        </div>
        <div class="col-md-4">
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" name={{ internaltourform.assign_to.name }}
                    id="{{ internaltourform.assign_to.auto_id }}1" value="PEOPLE" checked
                    onchange="showHideSelectField('PEOPLE')">
                <label class="form-check-label" for="{{ internaltourform.assign_to.auto_id }}">People</label>
            </div>
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" name={{ internaltourform.assign_to.name }}
                    id="{{ internaltourform.assign_to.auto_id }}2" value="GROUP" onchange="showHideSelectField('GROUP')">
                <label class="form-check-label" for="{{ internaltourform.assign_to.auto_id }}">Group</label>
            </div>
        </div>

        <!-- ASSIGN TO PEOPLE --->
        <div class="col-md-2">
            <label for={{ internaltourform.expirydatetime.id_for_label }} class="">{{ internaltourform.expirydatetime.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.expirydatetime }}
            {{ internaltourform.expirydatetime.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <!-- ASSIGN TO PEOPLE --->
        <div class="col-md-2 people">
            <label for={{ internaltourform.people.id_for_label }} class="">{{ internaltourform.people.label }}:</label>
        </div>
        <div class="col-md-4 people">
            {{ internaltourform.people }}
            {{ internaltourform.people.errors }}
        </div>
        <!-- ASSIGN TO GROUP --->
        <div class="col-md-2 pgroup">
            <label for={{ internaltourform.pgroup.id_for_label }} class="">{{ internaltourform.pgroup.label }}:</label>
        </div>
        <div class="col-md-4 pgroup">
            {{ internaltourform.pgroup }}
            {{ internaltourform.pgroup.errors }}
        </div>
        <!-- ASSIGN TO GROUP --->
        <div class="col-md-2">
            <label for={{ internaltourform.gracetime.id_for_label }} class="">{{ internaltourform.gracetime.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.gracetime }}
            {{ internaltourform.gracetime.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ internaltourform.jobstatus.id_for_label }} class="">{{ internaltourform.jobstatus.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.jobstatus }}
            {{ internaltourform.jobstatus.errors }}
        </div>
        <div class="col-md-2">
            <label for={{ internaltourform.starttime.id_for_label }} class="">{{ internaltourform.starttime.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.starttime }}
            {{ internaltourform.starttime.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ internaltourform.scantype.id_for_label }} class="">{{ internaltourform.scantype.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.scantype }}
            {{ internaltourform.scantype.errors }}
        </div>
        <div class="col-md-2">
            <label for="id_endtime" class="">End time:</label>
            <!-- <label for={{ internaltourform.endtime.id_for_label }} class="">{{ internaltourform.endtime.label }}:</label> -->
        </div>
        <div class="col-md-4">
            {{ internaltourform.endtime }}
            {{ internaltourform.endtime.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ internaltourform.priority.id_for_label }} class="">{{ internaltourform.priority.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.priority }}
            {{ internaltourform.priority.errors }}
        </div>
        <div class="col-md-2">
            <label for={{ internaltourform.performedby.id_for_label }} class="">{{ internaltourform.performedby.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.performedby }}
            {{ internaltourform.performedby.errors }}
        </div>
    </div>
    <div class="row mb-3 gy-3">
        <div class="col-md-2">
            <label for={{ internaltourform.ticketcategory.id_for_label }} class="">{{ internaltourform.ticketcategory.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.ticketcategory }}
            {{ internaltourform.ticketcategory.errors }}
        </div>
        <div class="col-md-2">
            <label for={{ internaltourform.gpslocation.id_for_label }} class="">{{ internaltourform.gpslocation.label }}:</label>
        </div>
        <div class="col-md-4">
            {{ internaltourform.gpslocation }}
            {{ internaltourform.gpslocation.errors }}
        </div>
    </div>
    <div class="row mb-3">
            <div class="col-md-2">
                <label for={{ internaltourform.remarkstype.id_for_label }} class="">{{ internaltourform.remarkstype.label }}:</label>
            </div>
            <div class="col-md-4">
                {{ internaltourform.remarkstype }}
                {{ internaltourform.remarkstype.errors }}
            </div>
            <div class="col-md-2">
                <label for={{ internaltourform.remarks.id_for_label }} class="">{{ internaltourform.remarks.label }}:</label>
            </div>
            <div class="col-md-4">
                {{ internaltourform.remarks }}
                {{ internaltourform.remarks.errors }}
            </div>
    </div>
</form>

<br><br>

<div class="child-jobs">
    <h4 class="card-title modal-heading">
        Tour Details &nbsp;<i class="fas text-white fs-3 text-primary fa-directions"></i>
    </h4><br>
    <table id="internal_tour" class="display cell-border" style="width:100%">
    </table><br>
    <h4 class="card-title modal-heading d-none">
        Tour Answers &nbsp;<i class="fas text-white fs-3 text-primary fa-directions"></i>
    </h4><br>
    <table id="tabTouranswers" class="display d-none cell-border" style="width:100%">
    </table>
</div>
{% endblock form %}


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
<div class="alert alert-danger" id="nonfield_errors"role="alert" style="display:none">
    <strong>Error</strong> <span></span>
</div>
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->

{% block popup_alerts %}
    {% call general_popup(title='Checklist Details <i class="fas text-white fa-tasks ch4"></i>', popup_id="id_checklistdetails", modal_size='modal-xl') %}
        <div class="modal-body">
            <table class="display cell-border" style="width:100%" id="tabChecklistDetails"></table>
        </div>
        
    {% endcall  %}
    {% call general_popup(title='Attachment Details <i class="fas text-white fa-paperclip ch4"></i>', popup_id="id_attachmentdetails", modal_size='modal-xl') %}
        <div class="modal-body">
            <table class="display cell-border" style="width:100%" id="tabAttachmentDetails"></table>
        </div>
        
    {% endcall  %}
    {{ mainattachment() }}
{% endblock popup_alerts %}

{% block ajax_page_actions %}
<div class="form-actions">
    {% if internaltourform.instance.jobstatus == "('ASSIGNED',)" %}
        {% if internaltourform.instance.id %}
        <button type="button" id="submitInternalTour" form="internaltourform" class="btn btn-sm btn-primary2 btn-hover-scale">
        Update Tour
        </button>
        <button type="button" onclick="deleteMainJob(this)" data-id="{{ internaltourform.instance.id }}" id="deleteAttd"
            class="btn btn-sm btn-danger btn-hover-scale">
            Delete&nbsp;<i class="fas text-white fa-trash-alt"></i>
        </button>
        {% else %}
            <button type="submit" form="internaltourform" class="btn btn-sm btn-primary2 btn-hover-scale">
                Save Tour&nbsp;<i class="fas text-white fa-cloud-upload-alt"></i>
            </button>
        {% endif %}
    {% endif %}
</div>
{% endblock ajax_page_actions %}

{% block extra_scripts %}
{{ internaltourform.media.js }}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/DataTables/Select-1.3.4/js/dataTables.select.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.8/js/dataTables.editor.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.8/js/editor.select2.js') }}" type="text/javascript"></script>
<script>
    //set the variables which are gonna used in attachment.js file for fetching attachments against the owner
    var attachmentParams = {
        attachmentUrl  : '{{ url("activity:attachments") }}',
        attachmentOwner: '{{ internaltourform.instance.uuid }}',
        csrf           : '{{ csrf_token }}',
        ownername      : "Jobneed",
        folderType     : 'internaltour',
        media_url      : '{{ MEDIA_URL }}',
        peopleid       : "{{ request.user.id }}"
    }
</script>
<script src="{{ static('assets/js/local/attachment.js') }}" type="text/javascript"></script>
<script>
    var table = null;
    var selected = null;
    var checklistdetails;
    var ajaxData = {};
    var attachmentDetails;
    var parentTable;
    var parent_id = '{{ internaltourform.instance.id }}';
    var childTable;
    var childEditor;
    var parentEditor;
    $('label').removeClass("col-form-label col-md-2 col-sm-2 text-sm-right")

    function hideAndShowFields(selected){
        if(typeof selected !== 'undefined'){
            if(selected === 'DROPDOWN' || selected === 'CHECKBOX' && typeof selected !== 'undefined'){
                childEditor.hide(['min', 'max', 'alertbelow', 'alertabove'], false).show(['alerton', 'options'], false)
            }else if(selected === 'NUMERIC'){
                childEditor.hide(['alerton', 'options'], false).show(['min', 'max', 'alertbelow', 'alertabove'], false)
            }else{
                childEditor.hide(['alerton', 'options', 'min', 'max', 'alertabove', 'alertbelow'])
            }
        }
    }

    function showCpDetails(id){
        $('#id_checklistdetails').modal('show')
        ajaxData.jobneedid=id
        ajaxData.action='checklist_details'
        checklistdetails.ajax.reload()
    }
    function showAttachmentDetails(id, from){
        $('#id_attachmentdetails').modal('show')
        ajaxData.id=id
        ajaxData.action = from === 'jobneed' ? 'getAttachmentJobneed' : 'getAttachmentJND' 
        attachmentDetails.ajax.reload()
    }

    function appenAlerton(options){
        clearSelection("#DTE_Field_alerton")
        for(let i=0; i<options.length; i++){
            
            if ($('#DTE_Field_alerton').find("option[value='" + options[i] + "']").length) {
                $('#DTE_Field_alerton').val(options[i]).trigger('change');
            } else { 
                // Create a DOM Option and pre-select by default
                var newOption = new Option(options[i], options[i], false, false);
                // Append it to the select
                $('#DTE_Field_alerton').append(newOption).trigger('change');
            } 
        }
    }

    function getCurrentEditingRow(editor, table){
        var rowModifier = editor.modifier();
        return rowModifier ? table.row(rowModifier).data() : 'None'
    }

    function initialize_form(){
        var data = getCurrentEditingRow(childEditor, childTable)
        if(data!=='None'){
            hideAndShowFields(data.answertype)
            //init question
            var newOption = new Option(data.quesname.split(' | ')[0], data.question_id, true, true);
            $('#DTE_Field_question').append(newOption).trigger('change');
            
            //init type
            var _selectedText = getSelectedValue("#DTE_Field_question")
            childEditor.field('answertype').val(_selectedText.split(" | ")[1])
            
            //init options
            //childEditor.field('options').val(data.options)
            
            //init alerton
            var options = data.options.split(',')
            if(options.length > 0){
                appenAlerton(options)
                let alerton = data.alerton.split(',')
                $("#DTE_Field_alerton").val(alerton).trigger('change')
            }
            
            if(data.answertype === 'NUMERIC' && data.alerton.length > 0){
                //init max
                childEditor.field('max').val(data.max)
                //init min
                childEditor.field('min').val(data.min)
                //init alertbelow and alertabove
                let alerton = data.alerton
                let aa = alerton.split(',')[1].replace('>', '') //alert-above
                let ab = alerton.split(',')[0].replace('<', '') //alert-below
                childEditor.field('alertbelow').val(ab)
                childEditor.field('alertabove').val(aa)
            }
        }
    }

    function clearSelection(id){
        //$(id).val(null).trigger('change');
        $(id).empty().trigger("change");
    }

    function clearForm(editor){
        ['min', 'max', 'alertbelow', 'alertabove', 'options'].forEach((ele) => {
            editor.field(ele).val('')
        })
        clearSelection("#DTE_Field_alerton")
        clearSelection("#DTE_Field_question")
    }
    //display readable form of gpslocation
    $('#id_gpslocation').val("{{ internaltourform.instance.geojson['gpslocation'] }}")

    

    $(document).ready(() => {
        // Disable checkboxes
        $("input[type='checkbox']").prop("disabled", true);

        // Disable text fields
        $("input, textarea").prop("disabled", true);

        // Disable select2 fields (assuming select2 has been initialized)
        $(".django-select2, .form-select").select2({"disabled": 'readonly'})
        //set ctzoffset
  	    $("#id_ctzoffset").val(-new Date().getTimezoneOffset())
        
        parentEditor = new $.fn.dataTable.Editor({
            table: "#internal_tour",
            ajax: {
                url:"{{ url('schedhuler:jn_jnd_editor') }}",
                data:function(d){
                    let currentRow = getCurrentEditingRow(parentEditor, parentTable)
                    console.log(currentRow)
                    d.parent_id = '{{internaltourform.instance.id}}'
                    d.tourjobneed = true
                    d.csrfmiddlewaretoken = '{{ csrf_token }}'
                    d.ctzoffset = $("#id_ctzoffset").val()
                    d.pk = currentRow !== 'None' ? currentRow['id'] : currentRow
                    console.log(d.pk)
                    d.qset_id = $('#DTE_Field_qsetname').val()
                    d.identifier = 'INTERNALTOUR'
                    d.seqno = $('#DTE_Field_seqno').val()
                    d.plandatetime = $('#DTE_Field_plandatetime').val()
                    d.expirydatetime = $('#DTE_Field_expirydatetime').val()
                    d.asset_id = $('#DTE_Field_asset_id').val()
                    d.seqno = $('#DTE_Field_seqno').val()
                    d.gracetime = $('#DTE_Field_seqno').val()
                }
            },
            idSrc:  'id',
            fields:[
                {label: 'SL.No', name: "seqno", type:"text"},
                {label: 'Plan Datetime', name: "plandatetime", type:'datetime', format:    'DD-MMM-YYYY HH:mm',},
                {label: 'Expiry Datetime', name: "expirydatetime", type:'datetime', format:    'DD-MMM-YYYY HH:mm',},
                {label: 'Checkpoint', name: "assetname"},
                {label: 'Checklist', name: "qsetname"},
                {label: 'gracetime', name: "gracetime"},              
            ]
        });

        //PARENT EDITOR ON PRE-OPEN EVENT
        parentEditor.on('preOpen', function(e, mode, action){
            
        })

        //PARENT EDITOR ON OPEN EVENT
        parentEditor.on('open', function(e, mode, action){
            $(".DTE_Field").addClass('p-1') // add required classes
            if(action == 'create'){
                parentEditor.field('seqno').set(parentTable.data().count() + 1)
            }
            
        })
        
        //PARENT EDITOR ON OPENED EVENT
        parentEditor.on('opened', function(e, mode, action){
            
        })


        //datatable configurations
        parentTable = $('#internal_tour').DataTable({
            ajax:{
                url:`{{ url('schedhuler:jobneedtourseditor') }}?action=get_tourdetails&parent_id=${parent_id}`,

            },
            responsive: true,
            dom:`<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
			 <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
            ordering: true,
            columns:[
                {data:'id', visible:false},
                {data:'seqno', title:'#'},
                {data:'plandatetime', title:'PlanDatetime'},
                {data:'expirydatetime', title:'Expiry Datetime'},
                {data:'asset__assetname', title:'Asset/Checkpoint'},
                {data:'qset__id', visible:false},
                {data:'qset__qsetname', title:'Checklist'},
                {data:'gracetime', title:'Gracetime'},
                {data:'jobstatus', title:'Status'},
                {title:'Attachments',data:null, defaultContent:null, render:function(data, type, row, meta){
                        return `<a href="javascript:void(0)"  onClick='showAttachmentDetails(${row['id']}, "jobneed")'>View</i></a>`
                    }
                },
                {title:'Details',data:null, defaultContent:null, render:function(data, type, row, meta){
                        return  `<button class="btn btn-link p-0" onClick='showCpDetails(${row['id']})'>View Details</button>`
                    }
                },
                {data:'ctzoffset', visible:false}

            ],
            ordering:false,
            deferRender: true,
            columnDefs:[
                {targets:1, data:'seqno', render:function(data, type, row, meta){
                        return parseInt(data)
                    }
                },
                {targets:2, render:function(data, type, row, meta){
                    return convert_to_local(type, data, row)}
                },
                {targets:3, render:function(data, type, row, meta){
                    return convert_to_local(type, data, row)}
                },
            ],
            buttons:[]
        })
        $('#id_checklistdetails').on('shown.bs.modal', function (event) {
            $.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
            $('#id_checklistdetails').modal({
                keyboard: false
            })
            checklistdetails = $("#tabChecklistDetails").DataTable(
            {
                ajax:{
                    url:`{{ url("schedhuler:jobneedtours") }}`,
                    data:function(d){
                    return  $.extend(d, ajaxData);
                    }
                },
                retrieve: true,
                columns:[
                    {data:'id', visible:false},
                    {data:'question__quesname', title:'Question'},
                    {data:'answertype', title:'Type'},
                    {data:'min', title:'Min'},
                    {data:'max', title:'Max'},
                    {data:'options', title:'Options'},
                    {data:'alerton', title:'Alert On'},
                    {data:'answer', title:'Answer'},
                    {data:'ismandatory', title:'Mandatory'},
                    {data: null, title:'Attachments', render:function(data, type, row, meta){
                        return `<a href="javascript:void(0)"  onClick='showAttachmentDetails(${row['id']}, "jnd")'>View</a>`
                    }
                    },
                    {data:'alerts', visible:false},
                ],
                createdRow:function(row, data, dataIndex){
                    if(data['alerts'] === true){
                        $(row).addClass('text-danger')
                    }
                },
                ordering:false,
                deferRender: true,
                scrollX: true,
                scrollY: 300,
                responsive:true,
                dom: `<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
                <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
                buttons:[],

            })
            
        })
        $('#id_attachmentdetails').on('shown.bs.modal', function (event) {
            $.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
                $('#id_attachmentdetails').modal({
                    keyboard: false
                })
                attachmentDetails = $("#tabAttachmentDetails").DataTable(
                {
                    ajax:{
                        url:`{{ url("schedhuler:jobneedtours") }}`,
                        data:function(d){
                        return  $.extend(d, ajaxData);
                        }
                    },
                    retrieve: true,
                    columns:[
                        { data: "id", visible: false },
                        {title:'SL No.', width:"5%", data:null, defaultContent:null, render:function (data, type, row, meta) { return meta.row  + 1; }},
                        { data: "filepath",  width:"5%", title:'File', render:function (data, type, row, meta) { return `<img src="{{ MEDIA_URL }}${row.filepath.replace('youtility4_media/', "")}/${row.filename}" class="card-img-top" target="_blank" alt="" style="width: 30px;height: 30px;">`; }},
                        { data: "filename",  title:'File Name' },
                        { data: null, width:"5%", defaultContent:null, title:"Action", render:function(data, type, row, meta ){
                        let file = `{{ MEDIA_URL }}${row.filepath.replace('youtility4_media/', "")}/${row.filename}`
                        return `<a href="${file}" target="_blank" class=""><i class="ch4 fas fa-eye"></i></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="${file}" download="${row.filename}"><i class="ch4 fas fa-save"></i></a>`;
                        } },
                    ],
                    ordering:false,
                    deferRender: true,
                    scrollX: true,
                    dom: `<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
                    <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
                    buttons:[],

                }
            )
            
        })

        //editor of child tabble
         /*childEditor = new $.fn.dataTable.Editor({
            table: '#tabTouranswers',
            ajax: {
                url:"{{ url('schedhuler:jn_jnd_editor') }}",
                data:function(d){
                    var selected = parentTable.row( { selected: true } )
                    if ( selected.any() ) {
                        let currentRow = getCurrentEditingRow(childEditor, childTable)
                        console.log(currentRow)
                        d.parent_id = selected.data().id;
                        d.csrfmiddlewaretoken = '{{ csrf_token }}'
                        d.question = true
                        d.alerton = JSON.stringify($("#DTE_Field_alerton").val())
                        d.question_id = $("#DTE_Field_question").val()
                        d.min = $("#DTE_Field_min").val()
                        d.max = $("#DTE_Field_max").val()
                        d.alertbelow = $("#DTE_Field_alertbelow").val()
                        d.alertabove = $("#DTE_Field_alertabove").val()
                        d.answertype = $("#DTE_Field_answertype").val()
                        d.seqno = $("#DTE_Field_seqno").val()
                        d.ismandatory = $("#DTE_Field_ismandatory").val()
                        d.options = $("#DTE_Field_options").val()
                        d.answer = $("#DTE_Field_answer").val()
                        d.pk = currentRow !== 'None' ? currentRow['pk'] : currentRow
                        d.ctzoffset = $("#id_ctzoffset").val()
                    }
                }
            },
            idSrc:  'pk',
            fields:[
                {data:'pk', type:'hidden', name:'pk', def:'None'},
                {label:'SNo.', name:"seqno", type:'text', data:'seqno'},
                {label: 'Question', name: 'question', type: 'select', data:'question'},
                {label: 'Type', name: 'answertype', type: 'readonly', data:'answertype'},
                {label: 'Min', name: 'min', type: 'text', def:null},
                {label: 'Max', name: 'max', type: 'text', def:null},
                {label: 'Alert below', name: 'alertbelow', type: 'text'},
                {label: 'Alert above', name: 'alertabove', type: 'text'},
                {label: 'Option', name: 'options', type:'text', fieldInfo:"Enter text ',' (comma) separated"},
                {label: 'Alert On', name: 'alerton', type:'select'},
                {label: 'Answer', name: 'answer', type:'text'},
                {label: 'Mandatory', name: 'ismandatory', type: 'select', def:1,
                options:   [
                    { label: 'True', value: 1 },
                    { label: 'False', value: 0 }
                ]},
            ],
            formOptions:{
                main:{
                    onReturn:false
                }
            }
        })

        //CHILD EDITOR ON PRE-OPEN EVENT
        childEditor.on('preOpen', function(e, mode, action){
            
        })

        //CHILD EDITOR ON OPEN EVENT
        childEditor.on('open', function(e, mode, action){
            
            // on change options set alerton
            if(action === 'create' || action === 'edit'){
                
                $('[data-dte-e="form"]').attr('id', 'id_childform') // add id to form
                $(".DTE_Field").addClass('p-1') // add css to form fields
                $("#DTE_Field_alerton, #DTE_Field_question").addClass("form-control form-select") // add css to alerton form field

                

                // initialize select field question
                init_select_field({
                    url: "{{ url('reports:config_sitereport_template') }}?action=loadQuestions",
                    id: "#DTE_Field_question",
                    item: 'Questoins'
                })
                
                // initialize select field alerton
                init_select_field({
                    id:'#DTE_Field_alerton',
                    client:true,
                    closeOnSelect:false,
                    multiple:true
                })

                // on change question select field, autoselect type field
                $("#DTE_Field_question.form-select").on("change", function () {
                    var _selectedText = getSelectedValue("#DTE_Field_question");
                    var selected = _selectedText.split(" | ")[1]
                    //hide/show fields based on selected text..
                    hideAndShowFields(selected)
                    childEditor.field('answertype').val(selected)
                })
            }
            
            
            if(action == "create"){
                childEditor.field('seqno').set(childTable.data().count() + 1) //update seqno for new entry
                clearForm(childEditor)
            }
            
        })

        // CHILD EDITOR ON OPENED EVENT
        childEditor.on('opened', function(e, mode, action){
            //get the data of rows in editing
            //var data = getCurrentEditingRow(childEditor, childTable)
            if(action == 'edit'){
                initialize_form()
            }
            //if(action == "edit" && data !== 'None'){
                //hide/show fields based on selected text..
                //hideAndShowFields(data.answertype)
            //}
            $("#DTE_Field_options").on('change', function(){
                var options  = $(this).val()
                if(options.length > 0){
                    appenAlerton(options.split(','))
                }else{
                    console.log('clear selection..........')
                    clearSelection("#DTE_Field_alerton")
                }
            })
        })

        // CHILD EDITOR ON POSTCREATE
        childEditor.on('postCreate', function(e, mode, action){
            //update the count of section
            rowData = parentTable.row({selected:true}).data()
            rowData.count++
            parentTable.row({selected:true}).data(rowData).draw()
        })


        //validations for child editor..
        childEditor.on('preSubmit', function(e, o, action){
            if(action !== 'remove' && this.field('answertype').val() == 'NUMERIC' ){
                let min = this.field('min')
                let max = this.field('max')
                let alertbelow = this.field('alertbelow')
                let alertabove = this.field('alertabove')
                console.log(!min.isMultiValue(), isNaN(parseInt(min.val(), 10)) == NaN)

                if(!(min.isMultiValue()) && isNaN(parseInt(min.val(), 10))) {min.error('value of min must be number')}
                if(!(max.isMultiValue()) && isNaN(parseInt(max.val(), 10))) {max.error('value of max must be number')}
                if(!(alertbelow.isMultiValue()) && isNaN(parseInt(alertbelow.val(), 10))) {alertbelow.error('value of alert below must be number')}
                if(!(alertabove.isMultiValue()) && isNaN(parseInt(alertabove.val(), 10))) {alertabove.error('value of alert above must be number')}

                if(!(min.isMultiValue() && max.isMultiValue()) && (parseInt(min.val(), 10) > parseInt(max.val(), 10)) ){
                    min.error('Min value must be smaller than Max value')
                }
                if(!(min.isMultiValue() && alertbelow.isMultiValue()) && (parseInt(alertbelow.val(), 10) < parseInt(min.val(), 10)) ){
                    alertbelow.error('Alert Below value must be greater than Min value')
                }
                if(!(max.isMultiValue() && alertabove.isMultiValue()) && (parseInt(alertabove.val(), 10)  > parseInt(max.val(), 10)) ){
                    max.error('Alert Above value must be smaller than Max value')
                }
                if(!(alertbelow.isMultiValue() && alertabove.isMultiValue()) && (parseInt(alertbelow.val(), 10) > parseInt(alertabove.val(), 10)) ){
                    alertabove.error('Alert Below value must be smaller than Alert Above value')
                }
                // If any error was reported, cancel the submission so it can be corrected
                if ( this.inError() ) {
                    return false;
                }

            }else if (this.field('answertype').val() == 'DROPDOWN' || this.field('answertype').val() == 'CHECKBOX'){
                let alerton = this.field('alerton')
                let options = this.field('options')
                if(!options.isMultiValue() && !options.val()){options.error('options must be given')}
                if ( this.inError() ) {
                    return false;
                }
            }

            
        })

        //report questoins
        childTable =$("#tabTouranswers").DataTable({
            ajax:{
                url:"{{ url('schedhuler:jn_jnd_editor') }}?action=get_jndofjobneed",
                type:'get',
                data:function(d){
                    var selected = parentTable.row( { selected: true } );
                        if ( selected.any() ) {
                        d.jobneedid = selected.data().id
                        d.count = selected.data().count
                    }

                }
            },
            responsive:true,
            ordering:false,
            searching:false,
            dom:`<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
            <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
            columns:[
                {data:'pk', defaultContent:null, visible:false},
                {data:'ctzoffset', defaultContent:null, visible:false},
                {title: "SNo", data:'seqno', render:function(data, type, row, meta){
                    return meta.row + 1
                }},
                {title: "Question", data: 'quesname'},
                {data: 'question_id', visible:false, defaultContent:null},
                {title: "Question Type", data: 'answertype'},
                {title: "Min", data: 'min', render:function(data, type, row, meta){
                    return row['answertype'] !== 'NUMERIC' ? 'NA' : data
                    
                }},
                {title: "Max", data: 'max', render:function(data, type, row, meta){
                    return row['answertype'] !== 'NUMERIC'  ? 'NA' : data
                }},
                {title: "Option", data: 'options', render:function(data, type, row, meta){
                    return row['answertype'] !== 'CHECKBOX' && row['answertype'] !== 'DROPDOWN' ? 'NA' : data
                }},
                {title: "Alert On", data: 'alerton', render:function(data, type, row, meta){
                    return row['answertype'] == 'CHECKBOX' || row['answertype'] == 'DROPDOWN' || row['answertype'] == 'NUMERIC' ? data : 'NA'
                }},
                {title: "Mandatory", data: 'ismandatory'},
                {title: "Answer", data: 'answer'},
            ],
            buttons:[
                { extend: "create", editor: childEditor },
                { extend: "edit",   editor: childEditor },
                { extend: "remove", editor: childEditor }
            ],
            select: {
                style: 'single'
            }
        })
        $("#tabTouranswers_wrapper .buttons-create").addClass('disabled')//on page load disable new button of child table
        $("#tabTouranswers_wrapper .buttons-create").attr({'data-toggle':"tooltip", 'data-placement':"top", 'title':"Select Section First"})
        
        parentTable.on( 'select', function () {
            childTable.ajax.reload();
            $("#tabTouranswers_wrapper .buttons-create").removeClass('disabled')
            //childEditor
            //    .field( 'users.site' )
            //    .def( parentTable.row( { selected: true } ).data().id );
        } );
        
        parentTable.on( 'deselect', function () {
            childTable.ajax.reload();
            $("#tabTouranswers_wrapper .buttons-create").addClass('disabled')
            $("#tabTouranswers_wrapper .buttons-create").attr({'data-toggle':"tooltip", 'data-placement':"top", 'title':"Select Section First"})
        } );*/


        //datetime widget configurations
        $("#id_child-plandatetime, #id_child-expirydatetime, #id_plandatetime, #id_expirydatetime").flatpickr({
            enableTime: true,
            time_24hr: true,
            dateFormat: 'd-M-Y H:S'
        })



        //middle form post request
        $("#internaltourform").submit((e) => {
            e.preventDefault();
            Swal.fire({
                title: "Submit Form",
                icon: "question",
                showCancelButton:true,
                confirmButtonText: "Submit it!"
            }).then((res) => {
                if(res.isConfirmed){
                    var params = {'url': "", modal:false}
                    var payload = {formData: $(this).serialize(), parentid : "{{ internaltourform.instance.id }}"}
                    fire_ajax_form_post(params, payload)
                    .done((data, status, xhr) => {
                        Swal.fire({
                            title: "Checkpoint Added Successfully!",
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1500
                        })
                    })
                    .fail((xhr, status, error) => {
                        display_form_errors(xhr.responseJSON.errors)
                    })

                }
            })
        })
    })
    
</script>
{% endblock extra_scripts %}