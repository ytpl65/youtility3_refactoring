{% extends "globals/base_form.html" %}


<!---- BEGIN PAGE TITLE ---->
{% block title %}
Schedule Report Form
{% endblock title %}
<!---- END PAGE TITLE ----->

{% block extra_css %}
{{ form.media.css }}
<link rel="stylesheet" href="{{ static('assets/css/jqCron.css') }}" type="text/css">
{% endblock extra_css %}


{% block form_title %}
Schedule Report Form
{% endblock form_title %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Schedule Report Form
    </a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


{% block nonfield_errors %}
{% if form.non_field_errors %}
{% for err in form.non_field_errors() %}
<div class="alert alert-danger w-100 alert-dismissible fade show">
    {{ err }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}

{% if messages %}
{% for msg in messages %}
<div class="alert {{ msg.tags }} w-100 alert-dismissible fade show" role="alert">
    {{ msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endblock nonfield_errors %}


{% block form %}
<form action="" method="post" class="validate" id="report_schedule_form">
    <input type="hidden" name="{{ form.ctzoffset.name }}" id="{{ form.ctzoffset.auto_id }}" value="-1">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="row">
        <div class="input-group mb-3">
            <div class="col-2">
                {{ form.report_type.label_tag() }}
            </div>
            <div class="col-5">
                {{ form.report_type }}
            </div>
        </div>
        <div class="input-group mb-3">
            <div class="col-2">
                {{ form.report_name.label_tag() }}
            </div>
            <div class="col-5">
                {{ form.report_name }}
            </div>
        </div>
        <!--CRON-->
        <div class="col-md-2">
            <label for="{{ form.cron.id_for_label }}" class="required">{{ form.cron.label }}:</label>
        </div>
        <div class="col-md-5 fv-row mb-3">
            <div class="d-flex">
                <input type="text" name="{{ form.cron.name }}"  id="id_cron"
                readonly required class="form-control d-none form-control-solid" maxlength="250"/>
                {{ form.cronstrue }}
                <a  class="btn btn-circle btn-icon-only btn-default " id="cron_selector">
                    <i class="fa fa-clock fs-4 text-primary"></i>
                </a>
            </div>
            {{ form.cron.errors }}
        </div>
        <div class="input-group mb-3">
            <div class="col-2">
                {{ form.report_sendtime.label_tag() }}
            </div>
            <div class="col-5">
                {{ form.report_sendtime }}
            </div>
        </div>
        <div class="input-group mb-3">
            <div class="col-2">
                {{ form.to_addr.label_tag() }}
            </div>
            <div class="col-5">
                {{ form.to_addr }}
            </div>
        </div>
        <div class="input-group mb-3">
            <div class="col-2">
                {{ form.cc.label_tag() }}
            </div>
            <div class="col-5">
                {{ form.cc }}
            </div>
        </div>
    </div>
    <div class="form-actions">
        <button type="submit" form="report_schedule_form" class="btn btn-sm btn-primary2 btn-hover-scale">
            Submit &nbsp;<i class="fas text-white fa-cloud-upload-alt"></i>
        </button>

        <button type="button" id="btn_clear" class="btn btn-sm btn-secondary btn-hover-scale">
            Clear&nbsp;<i class="fas  fa-times"></i>
        </button>
    </div>
</form>
{% endblock form %}


{% block popup_alerts %}
    {% call general_popup(popup_id = "cron_scheduler", title="Scheduler <i class='fas text-white fa-clock'></i>", modal_size='modal-lg') %}
        <div class="modal-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet-body form">
                        <div class="jqCronEditor"></div><br><br>
                        <div>
                            <p>Cron Value : <input type="text" id="cron_selected_val" readonly class="form-control input-inline input-large"/></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="btnSetCron"  class="btn btn-sm  btn-success rounded-1">Set</button>
        </div>
    {% endcall %}
{% endblock popup_alerts %}


{% block extra_scripts %}
{{ form.media.js }}
<script src="{{ static('assets/js/jqCron.js') }}"></script>
<script src="{{ static('assets/js/jqCron.en.js') }}"></script>
<script src="{{ static('assets/js/local/cronstrue.min.js') }}"></script>
<script>
    const urlname = "{{ url('reports:schedule_email_report') }}"
    function properCron(cron){
        return cron === '* * * * *' ? false :true
    }
    $(document).ready(() => {
        //set ctzoffset
        $("#id_ctzoffset").val(-new Date().getTimezoneOffset())

        $("#btn_clear").click(() => {
            location.href = `${urlname}?template=true`
        })

        //after cron set hide the modal
        $("#btnSetCron").click(function(){
            var cron_val= $("#cron_selected_val").val();
            $("#id_cron").val(cron_val);
            if(!properCron(cron_val)){
                show_error_alert( "Please change your cron expression and update the job record.", "Problematic Cron")
                return
            }
            $('#cron_scheduler').modal('hide');
        });

        //JQCRON CONFIGURATION
        $("#cron_selector").click(function(){
            var old_cron_val= $("#id_cron").val();
            $('#cron_selected_val').val(old_cron_val);
            if(old_cron_val == '') old_cron_val="* * * *";
            console.log("@@@@",old_cron_val);
            if(old_cron_val != ''){
                $(function(){
                    $('.jqCronEditor').html('');
                    $('.jqCronEditor').jqCron({
                        multiple_dom: true,
                        multiple_month: true,
                        multiple_mins: true,
                        multiple_dow: true,
                        multiple_time_hours: true,
                        multiple_time_minutes: true,
                        default_period: 'week',
                        default_value: old_cron_val,
                        no_reset_button: false,
                        lang: 'en',
                        numeric_zero_pad: true,
                        bind_to: $('#cron_selected_val'),
                        bind_method: {
                            set: function($element, value) {
                                $element.val(value);
                                //cron to readable format
                                $("#id_cronstrue").val(cronstrue.toString(value))
                            }
                        }
                    });
                });
            }
            $('#cron_scheduler').modal('show');
        });
    })
</script>
{% endblock extra_scripts %}