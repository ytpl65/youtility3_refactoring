{% extends "base_form.html" %}


{% block extra_css %}
{{ reporttemp_form.media.css }}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
<link  href="{{ static('assets/plugins/custom/Editor-2.0.6/css/editor.dataTables.css') }}" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('reports:sitereport_template_list') }}?template=true" class="pe-3">Site Report Templates</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Site Report Template Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Site Report Template
{% endblock form_title %}
<!------ END FORM TITLE -------->


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
    {% if reporttemp_form.non_field_errors() %}
    <div id="non_field_error" class="alert alert-danger" style="width: 73%;">
        {% for error in reporttemp_form.non_field_errors()[::-1] %}
        <strong>Error</strong> <span>{{ error }}</span>
        {% endfor %}
        <button type="button" class="btn-close flt-right" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->


{% block form %}
<form action="" method="post" id="sitereportTemplateForm" url="{{ url('reports:sitereport_template_form') }}">
    {{ reporttemp_form.type }}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <input type="hidden" name="pk" id="pk" value="">
    <div class="row gy-3">
    <!--FIELDS -->
    {% for field in reporttemp_form %}
        {% if(field.widget_type != 'checkbox' and field.name != 'type' ) %}
            <div class="col-sm-2">
                {{ field.label_tag() }}
            </div>
            <div class="col-sm-4">
            {{ field }}
            </div>
        {% elif field.widget_type == 'checkbox' %}
            <div class="col-sm-auto">
                <div class="form-check form-switch form-check-custom form-check-solid">
                {{ field }}
                <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
            </div>
            </div>
        {% endif %}
    {% endfor %}
    </div>
</form>
{% endblock form %}


{% block ajax_page_actions %}
<div class="form-actions">
    {% if reporttemp_form.instance.id %}
    <button type="submit" id="submitTour" form="sitereportTemplateForm" class="btn btn-sm btn-primary btn-hover-scale">
        Update &nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>

    <button type="button" onclick="deleteMainJob(this)" data-id="{{ reporttemp_form.instance.id }}" id="deleteAttd"
        class="btn btn-sm btn-danger btn-hover-scale">
        Delete&nbsp;<i class="fas fa-trash-alt"></i>
    </button>
    {% else %}
    <button type="submit" form="sitereportTemplateForm" class="btn btn-sm btn-primary btn-hover-scale">
        Save &nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>
    {% endif %}
</div>
{% endblock ajax_page_actions %}

{% block extras %}
<br><br><br>
<div class="report_section">
<div class="row mb-3 card">
    <div class="card-header">
        <div class="card-title">List Of Report Section</div>
    </div>
    <div class="card-body">
        <table id="tabSitereports" class="display cell-border compact">
            <thead>
            <tr>
            <th></th>
            <th>Id</th>
            <th>Section</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div tabindex="-1" id="jqGridSiteReportPager"></div>
    </div>
</div>
</div>
{% endblock extras %}

{% block extra_scripts %}
{{ reporttemp_form.media.js }}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.6/js/dataTables.editor.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.6/js/editor.select2.js') }}" type="text/javascript"></script>
<script>
    var tab_parent = null;
    var _pkid = null;
    var editor; 
    $(document).ready(function(){
        $("[multiple]").djangoSelect2({
          closeOnSelect:false 
      })
        function getFormData(id){
            return {
                'buincludes'        : $("#id_buincludes").val(),
                'site_grp_includes' : $("#id_site_grp_includes").val(),
                'qsetname'         : $("#id_qset_name").val(),
                'site_type_includes': $("#id_site_type_includes").val(),
                'enable'            : $("#id_enable").is(":checked"),
                'showto_allsites'   : $("#id_showto_allsites").is(":checked"),
                'type'   : $("#id_type").val()
            }
        }

        sectionEditor = new $.fn.dataTable.Editor({
                    ajax:"",
                    table:"#tabSitereports",
                    fields:[
                        {label:'Section', name:"qsetname"},
                    ]
                })

        if('{{ reporttemp_form.instance.id }}'  !== "None"){
            var pk = '{{ reporttemp_form.instance.id}}'
            $("#pk").val(pk)
             _pkid = pk }
        
        var tableSection = $("#tabSitereports").DataTable({
            ajax:{
                url:"{{ url('reports:sitereport_template_form') }}?get_reports=true",
                data:{'parent_id' : _pkid}
            },
            responsive: true,
			fixedHeader: true,
            searching:false,
            ordering:false,
            paging:false,
             dom:`<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
			 <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
            columns     : [
                {"className": 'details-control', "orderable": false,"data": null,"defaultContent": '', "width":'5%'},
                { "data": "id", visible:false, orderable:false, defaultContent:"" },
                { "data": "qsetname" },
            ],
            order:[[2, 'asc']],
            initComplete: function () {
          init = false;
        },
          createdRow: function ( row, data, index ) {
            if (data.extn === '') {
              var td = $(row).find("td:first");
              td.removeClass( 'details-control' );
            }
           },
          rowCallback: function ( row, data, index ) {
            //console.log('rowCallback');
           },
           buttons:[
				{ extend: "create", editor: sectionEditor, className:"btn btn-secondary", text:"Add New Section" },
			]
        })


        sectionEditor.on('create', function(e, json, data, id){
            console.log(data, json, id)
        })
        
            // Add event listener for opening and closing first level childdetails
            $('#tabSitereports tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = tableSection.row( tr );
                var rowData = row.data();
                var paraneRowPk = rowData[1]

                //get index to use for child table ID
                var index = row.index();
                if ( row.child.isShown() ) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }else{
                    //open this row
                    row.child( 
                    '<table class="child_table" id = "child_details' + index + '" cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
               '<thead><tr><th>Question</th><th>Type</th><th>Min</th><th>Max</th><th>Options</th><th>Alert On</th><th>Alert Mail Sends To</th><th></th><th>Alert Above</th><th>Alert Below</th></tr></thead><tbody>' +
                '</tbody></table><div id="childtoolbar' + index + '"></div>').show();
                    
                    var editor = new $.fn.dataTable.Editor({
                                table:"#child_details"+index,
                                //template:"#customForm",
                                fields:[
                                    {label:'Question', name:"question__quesname", type:"select"},
                                    {label:'Question Type', name:"answertype"},
                                    {label:'Min', name:"min", attr:{type:'number'}},
                                    {label:'Max', name:"max", attr:{type:'number'}},
                                    {label:'Alerton', name:"alerton"},
                                    {label:'Alert Above', name:"alertabove", attr:{type:'number'}},
                                    {label:'Alert Below', name:"alertabelow", attr:{type:'number'}},
                                    {label:'Mails Send to', name:"alertmailsendto"},
                                    {label:'Options', name:"options"},
                                ]
                            })


                    var child_table = $("#child_details" + index ).DataTable({
                        paging:false,
                        searching:false,
                        ordering:false,
                        columns:[
                            {data:'question__quesname', width:"25%"}, 
                            {data:'answertype'}, 
                            {data:'min', width:"4%"}, 
                            {data:'max', width:"4%"},
                            {data:'options'}, 
                            {data:'alerton', width:"4%"},
                            {data:'alertmailsendto', width:"10%"},
                            {data:'question_id', visible:false},
                            {data:'alertbelow'},
                            {data:'alertabove'},
                        ],
                        dom:'rtB',
                        buttons: [
                            { extend: "create", editor: editor, text:'<i class="fas fa-plus"></i>', className:'btn btn-sm btn-dark'},
                            { extend: "edit",   editor: editor, className:'btn btn-sm btn-dark',text:'<i class="fas fa-pen"></i>' },
                            { extend: "remove", editor: editor, className:'btn btn-sm btn-dark',text:'<i class="fas fa-trash"></i>' }
                        ],
                        order:[[1, 'asc']],
                        destroy:true,
                        scrollY:'100px'
                    })

                    editor.on('open', function(e, mode, action){
                        var input1 = document.querySelector("#DTE_Field_options");
                        console.log(input1, "&777777")
                        optionTag = new Tagify(input1);
                    })  
                    tr.addClass('shown');
                }
            })
        
        //on submit form post request
        $("#sitereportTemplateForm").submit((e) => {
            e.preventDefault()
            var form = $(this);
            const params   = { url: $(form).attr("action"), modal: false }
            var   payLoad  = $("#sitereportTemplateForm").serialize()
            console.log('payLoad', payLoad)
            
            fire_ajax_form_post(params, payLoad)
            .done((data, status, xhr) => {
                Swal.fire(
                    `Sitereport template saved`,
                    `Sitereport template with this name <strong>${data.msg}</strong> has been saved successfully`,
                    'success'
                ).then(function () {
                    formSaved = true
                    window.location.replace(data.url + `?id=${data.id}&template=true`);
                })
            })
            .fail((xhr, status, error) => {
                console.log(xhr, typeof(xhr.responseJSON.errors))
                if(typeof(xhr.responseJSON.errors) === 'string'){
                    show_error_alert(xhr.responseJSON.errors, "Failed to save!")
                }else{}
                
            })
        })
        
        
        
    })
</script>

{% endblock extra_scripts %}