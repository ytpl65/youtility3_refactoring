{% extends "base_form.html" %}


{% block extra_css %}
{{ reporttemp_form.media.css }}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
<link  href="{{ static('assets/plugins/custom/Editor-2.0.8/css/editor.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('reports:config_sitereport_template') }}?template=true" class="pe-3">Site Report Templates</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Site Report Template Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Site Report Template
{% endblock form_title %}
<!------ END FORM TITLE -------->


{% block form %}
<form action="" method="post" id="sitereportTemplateForm" url="{{ url('reports:sitereport_template_form') }}">
<input type="hidden" name="{{ reporttemp_form.ctzoffset.name }}" id = "{{ reporttemp_form.ctzoffset.auto_id }}" value="-1">
    {{ reporttemp_form.type }}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <input type="hidden" name="pk" id="pk" value="{{ reporttemp_form.instance.pk }}">
    <div class="row gy-3">
    <!--FIELDS -->
    {% for field in reporttemp_form %}
        {% if(field.widget_type != 'checkbox' and field.name not in ['type', 'ctzoffset'])  %}
            <div class="col-sm-2">
                {{ field.label_tag() }}
            </div>
            <div class="col-sm-4">
            {{ field }}
            </div>
        {% elif field.widget_type == 'checkbox' %}
            <div class="col-sm-auto">
                <div class="form-check form-switch form-check-custom form-check-solid">
                {{ field }}
                <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
            </div>
            </div>
        {% endif %}
    {% endfor %}
    </div>
</form>
{% endblock form %}


{% block ajax_page_actions %}
<div class="form-actions">
    {% if reporttemp_form.instance.id %}
    <button type="submit" id="submitTour" form="sitereportTemplateForm" class="btn btn-sm btn-primary btn-hover-scale">
        Update &nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>

    <button type="button" onclick="deleteMainJob(this)" data-id="{{ reporttemp_form.instance.id }}" id="deleteAttd"
        class="btn btn-sm btn-danger btn-hover-scale">
        Delete&nbsp;<i class="fas fa-trash-alt"></i>
    </button>
    {% else %}
    <button type="submit" form="sitereportTemplateForm" class="btn btn-sm btn-primary btn-hover-scale">
        Save &nbsp;<i class="fas fa-cloud-upload-alt"></i>
    </button>
    {% endif %}
</div>
{% endblock ajax_page_actions %}

{% block extras %}
<br><br><br>
<div class="report_section ">
<div class="row mb-3">
    <div class="col-sm-12 card">
        <div class="card-body">
            <h4 class="ch4">List Of Sections</h4>
            <table id="tabSitereports" class="display compact">
            </table>
            <br>
            <h4 class="ch4">Questions In The Selcted Section</h4>
            <table id="tabchildReport" class="display compact"></table>
        </div>
    </div>
</div>
</div>
{% endblock extras %}

{% block extra_scripts %}
{{ reporttemp_form.media.js }}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.8/js/dataTables.editor.min.js') }}" type="text/javascript"></script>

<script>
    var tab_parent = null;
    var _pkid = null;
    var editor;
    var optionTag = null
    var sectionEditor;

    $(document).ready(function(){
        //set ctzoffset
  	    $("#id_ctzoffset").val(-new Date().getTimezoneOffset())
        


        //tagifying the options field
        /*var input1 = document.querySelector("#id_options");
        optionTag = new Tagify(input1);

        //on adding/removing options in 
        //question-form trigger following events
        optionTag
        .on('add', function (e) {
            populateAlertOn(e.detail.data.value)
        })
        .on('remove', function (e) {
            console.log(e.detail.data.value)
            removeElmtFromAlertOn(e.detail.data.value)
        })*/

        //on submitting the questionset-blng form populate the table
        // "List of Assigned Questions"
        /*$('#qsetbng_form').on('submit', function (e) {
            e.preventDefault()
            if ($("#id_answertype").val() === 'NUMERIC') {
                if (qsetbng_form_validator) {
                    qsetbng_form_validator.validate().then(function (status) {
                        if (status === 'Valid') {
                            get_question_formdata()
                            data = cleanData(data)
                            Swal.fire(
                            'Added!',
                            'You clicked the button!',
                            'success'
                            )
                            
                        }
                    })
                }
            } else {
                processValidForm()
                adjustSlnoInTable()
                console.log("processing valid form [END]")
            }
        });


        //on selecting the question from question form show/hide
        //the fields group of class "optionGroup" and "numeric"
        $("#id_question.form-select").on("change", function () {
            var _selectedText = getSelectedValue("#id_question");
            var selected = _selectedText.split(" | ")[1]
            if (typeof selected !== 'undefined') {
                assignQuesType(selected)
                showHideFields(selected)
            }
        })
        
        //get main (upper) form data
        function getFormData(id){
            return {
                'buincludes'        : $("#id_buincludes").val(),
                'site_grp_includes' : $("#id_site_grp_includes").val(),
                'qsetname'         : $("#id_qset_name").val(),
                'site_type_includes': $("#id_site_type_includes").val(),
                'enable'            : $("#id_enable").is(":checked"),
                'showto_allsites'   : $("#id_showto_allsites").is(":checked"),
                'type'   : $("#id_type").val()
            }
        }*/
        

        //editor section table
        var parentEditor = new $.fn.dataTable.Editor({
            table: "#tabSitereports",
            fields:[
                {label: 'Section', name: "qsetname"},
            ]
        });

        //parentEditor on open
        parentEditor.on('open', function(e, mode, action){
            //add required classes
            $(".DTE_Field").addClass('p-1')
        })


        //editor of child tabble
        var childEditor = new $.fn.dataTable.Editor({
            table: '#tabchildReport',
            fields:[
                {label: 'Question', name: 'question', type: 'select'},
                {label: 'Type', name: 'answertype', type: 'readonly'},
                {label: 'Min', name: 'min', type: 'text'},
                {label: 'Max', name: 'max', type: 'text'},
                {label: 'Alert below', name: 'alertbelow', type: 'text'},
                {label: 'Alert above', name: 'alertabove', type: 'text'},
                {label: 'Option', name: 'option'},
                {label: 'Alert On', name: 'alerton'},
                {label: 'Mandatory', name: 'ismandatory', type: 'checkbox', separator: "|",
                options:   [
                    { label: '', value: 1 }
                ]},

            ]
        })

        //op open form event
        childEditor.on('open', function(e, mode, action){
            //add required classes
            $("#DTE_Field_question").addClass("form-select form-select-solid")
            $(".DTE_Field").addClass('p-1')
            
            //$("#DTE_Field_question").djangoSelect2()
            var params = {
                url: "{{ url('reports:config_sitereport_template') }}?action=loadQuestions",
                id: "#DTE_Field_question",
                item: 'Questoins'
            }
            //initialize select field
            init_select_field(params)

            //on change question select field, autoselect type field
            $("#DTE_Field_question.form-select").on("change", function () {
                var _selectedText = getSelectedValue("#DTE_Field_question");
                var selected = _selectedText.split(" | ")[1]
                //hide/show fields based on selected text..
                if(selected === 'DROPDOWN'){
                    childEditor.hide(['min', 'max', 'alertbelow', 'alertabove'], false).show(['alerton', 'option'], false)
                }else if(selected === 'NUMERIC'){
                    childEditor.hide(['alerton', 'option'], false).show(['min', 'max', 'alertbelow', 'alertabove'], false)
                }
                childEditor.field('answertype').val(selected)
            })
        })


        //validations for child editor..
        childEditor.on('preSubmit', function(e, o, action){
            if(action !== 'remove'){
                let min = this.field('min')
                let max = this.field('max')
                let alertbelow = this.field('alertbelow')
                let alertabove = this.field('alertabove')
                
                if(!( min.isMultiValue() && max.isMultiValue() )){
                    if(!alertabove.isMultiValue()){
                        if(alertabove.val() > max.val()){
                            alertabove.error('alertabove value must be smaller than max value')
                        }
                    }else{
                        alertabove.error('alertabove must be number')
                    }
                }


                if (!( min.isMultiValue() && max.isMultiValue() ) && ( max.val() < min.val() ) ){
                    max.error('max value must be greater than min value')
                }
                if( !(alertabove.isMultiValue() && alertbelow.isMultiValue()) &&  (alertabove.val() < alertbelow.val()) ){
                    alertabove.error('alertabove value must be greater than alertbelow value')
                }

                    if(alertabove.val() < max.val()){
                        alertabove.error('alertabove value must be smaller than max value')
                    }
                    if(alertbelow.val() < min.val()){
                        alertbelow.error('alertbelow value must be greater than min value')
                    }
                    if(! (min.isMultiValue() && (typeof min.val() === 'number')) ){min.error('value of min must be number')}
                    if(! (max.isMultiValue() && (typeof max.val() === 'number'))){max.error('value of max must be number')}
                    if(! (alertbelow.isMultiValue() && typeof alertbelow.val() === 'number')){alertbelow.error('value of alert below must be number')}
                    if(! (alertabove.isMultiValue() && typeof alertabove.val() === 'number')){alertabove.error('value of alert above must be number')}
                
                // If any error was reported, cancel the submission so it can be corrected
                if ( this.inError() ) {
                    return false;
                }

            }
        })
        
        


        //datatable configuration tabSiteReports       
        var parentTable = $("#tabSitereports").DataTable({
            ajax:{
                url: "{{ url('reports:config_sitereport_template') }}?get_reports=true",
                
            },
            responsive: true,
            searching:false,
            ordering:false,
            paging:false,
            dom:`<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
            <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
            columns     : [
                {data: 'id', defaultContent:null, visible:false},
                {title: "Section", data: 'qsetname'},
                {title: "Count", width: "15%",data:null, render:function(data){
                    return data.length()
                }},
            ],
            buttons:[
                { extend: "create", editor: parentEditor },
                { extend: "edit",   editor: parentEditor },
                { extend: "remove", editor: parentEditor }
            ],
            select: {
                style: 'single'
            }
        })

        //report questoins
        var chlldTable =$("#tabchildReport").DataTable({
            ajax:{
                url: "{{ url('reports:config_sitereport_template') }}?action=saveChildQuestion",
                data:function(d){
                    var selected = parentTable.row({selected:true});
                    if(selected.length > 0){
                        d.id = selected.data().id
                    }
                }
            },
            responsive:true, 
            ordering:false,
            searching:false,
            dom:`<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
            <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
            columns:[
                {title: "SNo", data:null, render:function(data, type, row, meta){
                    return meta.row + 1
                }},
                {title: "Question", data: 'quesname'},
                {title: "Question Type", data: 'answertype'},
                {title: "Min", data: 'min'},
                {title: "Max", data: 'max'},
                {title: "Option", data: 'option'},
                {title: "Alert On", data: 'alerton'},
                {title: "Mandatory", data: 'ismandatory'},
            ],
            buttons:[
                { extend: "create", editor: childEditor },
                { extend: "edit",   editor: childEditor },
                { extend: "remove", editor: childEditor }
            ],
        })


        
        //on submit form post request
        $("#sitereportTemplateForm").submit((e) => {
            e.preventDefault()
            var form = $(this);
            const params   = { url: $(form).attr("action"), modal: false }
            var   payLoad  = $("#sitereportTemplateForm").serialize()
            console.log('payLoad', payLoad)
            
            fire_ajax_form_post(params, payLoad)
            .done((data, status, xhr) => {
                Swal.fire(
                    `Sitereport template saved`,
                    `Sitereport template with this name <strong>${data.msg}</strong> has been saved successfully`,
                    'success'
                ).then(function () {
                    formSaved = true
                    window.location.replace(data.url + `?id=${data.id}&template=true`);
                })
            })
            .fail((xhr, status, error) => {
                console.log(xhr, typeof(xhr.responseJSON.errors))
                if(typeof(xhr.responseJSON.errors) === 'string'){
                    show_error_alert(xhr.responseJSON.errors, "Failed to save!")
                }else{}
                
            })
        })
       
    })
</script>
{# <script src="{{ static('assets/js/formValidations.js') }}"></script>#}
{% endblock extra_scripts %}