{% extends "base_form.html" %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('onboarding:shift_list') }}" class="pe-3">Shift List</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Shift Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


<!-------------  BEGIN POP-UPS CODE -------------->
{% block popup_alerts %}
{{ super()  }}
{% if edit is defined %}
<!-- to delete an instance with popup_alert pass the delete_url_name, instance_id, popup_title, popup_id -->
{% call general_popup(title="Delete", popup_id="delete_alert") %}
<div class="modal-body">
    <h4>Are you sure, you want to delete this?</h4>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">No Go back</button>
    <a href="{{ url('onboarding:shift_delete', args=[shift_form.instance.id]) }}"
        class="btn btn-sm  btn-danger rounded-1">Yes I'm Sure</a>
</div>
{% endcall %}
{% endif %}
{% endblock popup_alerts %}
<!-------------  END POP-UPS CODE -------------->


<!---- BEGIN PAGE TITLE --->
{% block form_title %}
Create Shift
{% endblock form_title %}
<!---- END PAGE TITLE ---->


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
{% if shift_form.non_field_errors() %}
<div id="non_field_error" class="alert alert-danger alert-dismissible fade show" role="alert" style="width: 73%;">
    <strong>ERROR</strong>
    {% for error in shift_form.non_field_errors() %}
    <span>{{ error }}</span>
    {% endfor %}
    <button type="button" class="btn-close flt-right" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->



<!-------------- BEGIN FORM ------------------->
{% block form %}
<form action="" method="post" id="id_shiftform">
    <!-------------------------- CSRF MIDDLEWARE TOKEN --------------------->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="mb-3 row g-3 gx-6">
        <!--SHIFTNAME-->
        <label class="required col-form-label col-md-2 col-sm-2 text-sm-right" for="id_shift_form-shiftname">Shift Name:
            <span class="material-icons-outlined h-19px" style="vertical-align: middle; font-size: 19px;"
                data-bs-toggle="tooltip" data-bs-custom-class="tooltip" data-bs-placement="top"
                title="Display name of the shift">
                info
            </span>
        </label>
        <div class="col-md-4">
            {{ shift_form.shiftname }}
            {{ shift_form.shiftname.errors }}
        </div>
        <!--STARTTIME-->
        <label class="required col-form-label col-md-2 col-sm-2 text-sm-right" for="id_shift_form-starttime">Start Time:
            <span class="material-icons-outlined h-19px" style="vertical-align: middle; font-size: 19px;"
                data-bs-toggle="tooltip" data-bs-custom-class="tooltip" data-bs-placement="top"
                title="Enter starttime of shift">
                info
            </span>
        </label>
        <div class="col-md-4">
            {{ shift_form.starttime }}
            {{ shift_form.starttime.errors }}
        </div>
        <!--CAPCTCHA FREQUENCY-->
        <label class="required col-form-label col-md-2 col-sm-2 text-sm-right"
            for="id_shift_form-captchafreq">Captchafreq:
            <span class="material-icons-outlined h-19px" style="vertical-align: middle; font-size: 19px;"
                data-bs-toggle="tooltip" data-bs-custom-class="tooltip" data-bs-placement="top" title="">
                info
            </span>
        </label>
        <div class="col-md-4">
            {{ shift_form.captchafreq }}
            {{ shift_form.captchafreq.errors }}
        </div>
        <!--ENDTIME-->
        <label class="required col-form-label col-md-2 col-sm-2 text-sm-right" for="id_shift_form-endtime">End Time:
            <span class="material-icons-outlined h-19px" style="vertical-align: middle; font-size: 19px;"
                data-bs-toggle="tooltip" data-bs-custom-class="tooltip" data-bs-placement="top"
                title="Enter endtime of shift">
                info
            </span>
        </label>
        <div class="col-md-4">
            {{ shift_form.endtime }}
            {{ shift_form.endtime.errors }}
        </div>
        <!--NIGHTSHIFT APPLICABLE-->
        <div class="booleans col-md-6 d-flex justify-content-sm-start mt-5">
             <label for=id_nightshift_appicable class="form-check-label bool col-form-label me-5 text-sm-right">Night Shift Applicable
                          <span class="material-icons-outlined h-19px" style="vertical-align: middle; font-size: 19px;"
                data-bs-toggle="tooltip" data-bs-custom-class="tooltip" data-bs-placement="top"
                title="Enable this checkbox for Night Shift">
                info
            </span>&nbsp;{{ shift_form.nightshift_appicable }}</label>
        </div>
        <!--SHIFT DURATION-->
        <label class="col-form-label col-md-2 col-sm-2 text-sm-right" for="id_shiftduration">Shift duration:
            <span class="material-icons-outlined h-19px" style="vertical-align: middle; font-size: 19px;"
                data-bs-toggle="tooltip" data-bs-custom-class="tooltip" data-bs-placement="top"
                title="Total shift duration">
                info
            </span>
        </label>
        <div class="col-md-4">
            {{ shift_form.shiftduration }}
            {{ shift_form.shiftduration.errors }}
        </div>
    </div>
</form>

{% endblock form %}
<!------------- END FORM ---------------------->




<!-------------- BEGIN FORM PAGE ACTIONS --------->
{% block formpage_actions %}
{% if request.session['wizard_data'] is defined %}
<!--- BEGIN wizard Controls --->
{{ super() }}
<!-- END wizard Controls ------>
{% else %}

<!--- BEGIN Normal Form Controls -->
{% if edit is defined %}
{{ form_update('id_shiftform', popup_id="delete_alert") }}
{% else %}
{{ form_create('id_shiftform') }}
{% endif %}
<!----- END Normal Form Controls --->

{% endif %}
{% endblock formpage_actions %}
<!---------------- END FORM PAGE ACTIONS ----------->



<!--------------- BEGIN PAGE-LEVEL EXTRA SCRIPTS --------------->
{% block extra_scripts %}
<script>
    const formatMins = (duration) => {
                return Math.floor(duration / 60) + 'Hrs, ' + duration % 60 + "min";
            }
        //format mins to readable format
        var val = $("#id_shiftduration").val()
        if(val != ""){
            let mins = parseInt(val);
            $("#id_shiftduration").val(formatMins(mins))
        }
    
    $(document).ready(function () {
        //hide the delete button when instance is not saved yet.
        if ('{{shift_form.instance.id}}' == 'None') {
            $("#btn_del").hide()
        }
        //adding time widget to starttime and endtime
        $('#id_starttime, #id_endtime').flatpickr({
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true
        })
        //hide next btn if instance is not saved yet
        if (session['wizard_data'] && session['wizard_data']['shiftids'].length == 0) {
            $('#next_btn').hide()
        }
        
        //alert user about night shift
        const nightShiftAlert = {
            title:"Night shift alert",
            text: `According to Start time & End Time do you want to create a 'Night Shift',
                then the checkbox 'Night Shift Applicable will be enabled by default'`,
            icon:"warning",
            showCancelButton:true,
            confirmButtonText: 'Go for it!',
            allowOutsideClick: false
        }
        const alertUser = () => {
            Swal.fire(nightShiftAlert).then((res) => {
                if (res.isConfirmed){
                    $("#id_nightshift_appicable").prop('checked', true)
                }else{
                    $("#id_starttime, #id_endtime, #id_shiftduration").val("")
                    $("#id_nightshift_appicable").prop('checked', false)
                }
            })
        }

        //total shift duration
        $("#id_starttime, #id_endtime").change(() => {
            var st = moment($("#id_starttime").val(), "HH:mm")
            var et = moment($("#id_endtime").val(), "HH:mm")
            var duration = moment.duration(et.diff(st)).asMinutes()
            if(duration < 0){
                duration = 1440 + duration
                alertUser()
            }else{
                $("#id_nightshift_appicable").prop('checked', false)
            }
            var totalhrs = formatMins(duration)
            console.log("totalhrs", totalhrs)
            if(totalhrs !== 'NaNHrs, NaNmin'){
                $("#id_shiftduration").val(totalhrs)
            }

        })
        
    })


</script>
{% endblock extra_scripts %}
<!--------------- END PAGE-LEVEL EXTRA SCRIPTS --------------->