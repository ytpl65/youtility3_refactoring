{% extends "base_form.html" %}

{% block extra_css %}
<link href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css" />
{{ importform.media.css }}
<style>
    .vl {
        border-right: 1px solid grey;
    }
</style>

<div class="vl"></div>
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('home') }}?template=true" class="pe-3">Home</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Import Export</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Import Data
{% endblock form_title %}
<!------ END FORM TITLE -------->

{% block form %}
<div class="row gx-8">
    <div class="col-md-6">
        <p class="ch4 y-primary mb-2">Please follow the instructions before uploading any data:</p>
        <ol class="list-group ps-2 list-group-numbered">
            <li class="list-group-item">File format of .xlsx should be used for seamless operation</li>
            <li class="list-group-item">Do not use any type of column formatting, only text to be used</li>
            <li class="list-group-item">It is mandatory to leave the first column empty</li>
        </ol>
    </div>
    
    <div class="col-md-6">
        <form action="" method="post" id="id_import_form" enctype="multipart/form-data">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div class="row mb-3">
                <div class="col-md-3 mb-3">
                    {{ importform.table.label_tag() }}
                </div>
                <div class="col-md-9 mb-3">
                    {{ importform.table }}
                </div>
                <div class="col-md-3 mb-3">
                    <label for="">Download Template:</label>
                </div>
                <div class="col-md-9 mb-3">
                    <button type="button"  class="btn btn-sm btn-secondary" id="btn_download">download</button>
                </div>
                <div class="col-md-3 mb-3">
                    {{ importform.importfile.label_tag() }}
                </div>
                <div class="col-md-9 mb-3">
                    {{ importform.importfile }}
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary" id="btn_importdata">Import Data</button>
        </form>
        <table id="import_datatable"></table>
    </div>
</div>
{% endblock form %}


{% block extra_scripts %}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script>
    var _columns = {{columns |default ("[]") | tojson }}
    const DATA = {{ data |default ("[]") | tojson }}
    var table = null;
    const urlname = '{{ url("onboarding:import") }}'

    $(document).ready(function () {

        //on click downnload template
        $('#btn_download').click(() => {
            let params = {url:urlname, data:{action:"downloadTemplate", template:$("#id_table").val()} }
            fire_ajax_get(params)
            .done((data, status, xhr) => {
                var blob = new Blob([xhr], {type: 'application/vnd.ms-excel'})
                var link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = 'template.xlsx';
                link.click();
            })
            .error((xhr, status, error) => {
                console.log(error)
            })
        })

        //submit form with data-file
        $("#btn_importdata").click(() => {
            var fd = new FormData();
            fd.append('table', $("#id_table").val())
            const input = $('#id_importfile')[0].files[0] //document.querySelector('#id_importfile');
            fd.append('importfile', input);
            fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');


            const params = {
                url: urlname,
                modal: false
            }
            const payLoad = {
                formData: fd,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }

            Swal.fire({
                title: "Submit",
                text: 'Are you sure the the file you uploading has correct data?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes Upload it!'
            }).then((res) => {
                $.ajax({
                    url: params.url,
                    data: fd,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function (res) {
                        
                        console.log(res)
                        if(res.rc === 1){
                            //initialize table with errors
                            if(table){
                                table.destroy()
                            }else{
                              table =  $('#import_datatable').DataTable({
                                data:res.data,
                                columns:res.columns,
                                columnDefs:{targets: Array(res.no_of_cols).fill(null).map((_, i) => i), render:function(data, type, row, meta ){return data || '--'} }
                                })
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr)
                    }
                })
            })
        })

        if ($.fn.DataTable.isDataTable('#import_data_table')) {
            table = $('#import_data_table').DataTable();
            table.destroy();
            $('#import_data_table').empty();
        }

        //DataTable configuration
        $("#import_data_table").DataTable({
            data: JSON.parse(DATA),
            columns: JSON.parse(_columns),
            deferRender: true,
            ordering: false,
            responsive: true,
            dom: `<'row' >rt<'row'>`,
            columnDefs: [{
                targets: 0,
                visible: false,
                defaultContent: null
            }]
        })
    })
</script>
{% endblock extra_scripts %}