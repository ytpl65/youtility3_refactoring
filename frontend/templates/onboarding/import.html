{% extends "base_form.html" %}

{% block extra_css %}
<link href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css" />
{{ importform.media.css }}
<style>
    .vl {
        border-right: 1px solid grey;
    }

    table.dataTable tbody tr.error_row td, .dataTables_scrollBody table thead tr th{
        background-color: rgb(255, 204, 207)!important;
    }
    table.dataTable tbody tr.valid_row td,  .dataTables_scrollBody table thead tr th{
        background-color: rgb(182, 255, 182)!important;
    }
</style>

<div class="vl"></div>
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('home') }}?template=true" class="pe-3">Home</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Import Export</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Import Data
{% endblock form_title %}
<!------ END FORM TITLE -------->

{% block form %}
<div class="row gx-8">
    <div class="col-md-6">
        <p class="ch4 y-primary mb-2">Please follow the instructions before uploading any data:</p>
        <ol class="list-group ps-2 list-group-numbered">
            <li class="list-group-item">File format of .xlsx should be used for seamless operation</li>
            <li class="list-group-item">Do not use any type of column formatting, only text to be used</li>
            <li class="list-group-item">It is mandatory to leave the first column empty</li>
            <li class="list-group-item">If you want to enter nothing into the cell, then enter 'NONE'</li>
        </ol>
    </div>
    
    <div class="col-md-6">
        <form action="" method="post" id="id_import_form" enctype="multipart/form-data">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

            <div class="row mb-3">
                <div class="col-md-3 mb-3">
                    {{ importform.table.label_tag() }}
                </div>
                <div class="col-md-9 mb-3">
                    {{ importform.table }}
                </div>
                <div class="col-md-3 mb-3">
                    <label for="">Download Template:</label>
                </div> 
                <div class="col-md-9 mb-3">
                    <button type="button"  class="btn btn-sm btn-secondary" id="btn_download">download</button>
                </div>
                <div class="col-md-3 mb-3">
                    {{ importform.importfile.label_tag() }}
                </div>
                <div class="col-md-9 mb-3">
                    {{ importform.importfile }}
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary2" id="btn_importdata">Import Data</button>
        </form>
    </div>
</div>
{% endblock form %}


{% block extras %}
<hr>
<table id="import_datatable" class="display compact"></table>
{% endblock extras %}


{% block extra_scripts %}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script>
    var _columns = {{columns |default ("[]") | tojson }}
    const DATA = {{ data |default ("[]") | tojson }}
    var table = null;
    const urlname = '{{ url("onboarding:import") }}'

    $(document).ready(function () {
        //set ctzoffset
        $("#id_ctzoffset").val(-new Date().getTimezoneOffset())

        //on click download template
        $('#btn_download').click(() => {
            let table = $("#id_table").val();
            let url = `${urlname}?action=downloadTemplate&template=${table}`;

            fetch(url, {
                method: 'GET'
            })
            .then(response => {
                // extract filename from Content-Disposition header
                let filename = response.headers.get('Content-Disposition').split('=')[1];
                filename = filename.replace(/"/g, '');  // Remove quotes if they exist

                return response.blob().then(data => {
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(data);
                    link.download = filename;
                    link.click();
                });
            })
            .catch(error => console.log(error));
        });



        //submit form with data-file
        $("#btn_importdata").click(() => {
            var fd = new FormData();
            fd.append('table', $("#id_table").val())
            const input = $('#id_importfile')[0].files[0] //document.querySelector('#id_importfile');
            fd.append('importfile', input);
            fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');


            const params = {
                url: urlname,
                modal: false
            }
            const payLoad = {
                formData: fd,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }

            Swal.fire({
                title: "Submit",
                text: 'Are you sure the the file you uploading has correct data?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes Upload it!'
            }).then((res) => {
                $.ajax({
                    url: params.url,
                    data: fd,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function (res) {
                        if (res.rc === 1) {
                            // Initialize table with errors
                            if (table) {
                                table.destroy();
                            }
                            table = $('#import_datatable').DataTable({
                                data: res.data,
                                columns: res.columns,
                                dom:'rtip',
                                deferRender: true,
                                responsive:True,
                                pageLength:10,
                                columnDefs: [
                                    {targets:0, data:'Row#', width:"9%"},
                                    {
                                        targets: Array(res.no_of_cols).fill(null).map((_, i) => i),
                                        render: function (data, type, row, meta) {
                                            return data || '--';
                                        }
                                    }
                                ],
                                rowCallback: function(row, data, index) {
                                    $(row).addClass('error_row');
                                }
                            });
                            
                            // Enable Bootstrap tooltips
                            $('[data-toggle="tooltip"]').tooltip();
                            
                            // Add event listener to confirm button
                            $('#confirm_import_button').click(function () {
                                Swal.fire({
                                    title: 'Confirm Import',
                                    text: 'Are you sure you want to import the data?',
                                    icon: 'question',
                                    showCancelButton: true,
                                    confirmButtonText: 'Import',
                                    cancelButtonText: 'Cancel'
                                }).then(function (result) {
                                    if (result.isConfirmed) {
                                        // Perform import
                                        performImport();
                                    }
                                });
                            });
                        } else {
                            table = $('#import_datatable').DataTable({
                                data: res.preview_data,
                                columns: res.columns,
                                columnDefs: [
                                    {
                                        targets: Array(res.no_of_cols).fill(null).map((_, i) => i),
                                        render: function (data, type, row, meta) {
                                            return data || '--';
                                        }
                                    },
                                    {
                                        targets: -1,
                                        render: function (data, type, row, meta) {
                                            if (row.error) {
                                                return `<span class="error-tooltip" data-toggle="tooltip" data-placement="top" title="${row.error}">Error</span>`;
                                            }
                                            return '';
                                        }
                                    }
                                ],
                                "rowCallback": function(row, data, index) {
                                    $(row).addClass('valid_row');
                                },
                                buttons:[

                                ]
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr);
                    }
                });
            })
        })

        if ($.fn.DataTable.isDataTable('#import_data_table')) {
            table = $('#import_data_table').DataTable();
            table.destroy();
            $('#import_data_table').empty();
        }

        //DataTable configuration
        $("#import_data_table").DataTable({
            data: JSON.parse(DATA),
            columns: JSON.parse(_columns),
            deferRender: true,
            ordering: false,
            responsive: true,
            dom: `<'row' >rt<'row'>`,
            columnDefs: [{
                targets: 0,
                visible: false,
                defaultContent: null
            }]
        })
    })
</script>
{% endblock extra_scripts %}