{% extends "base_form.html" %}
{% from "onboarding/partials/partial_ta_form.html" import typeassist_form with context %}


{% block extra_css %}
{{ buform.media.css }}
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('onboarding:bu_list') }}?template=true" class="pe-3">Bu List</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Bu Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->


<!-------------  BEGIN POP-UPS CODE -------------->
{% block popup_alerts %}
	{{ super() }}
	{% if edit is defined %}
	<!-- to delete an instance with popup_alert pass the delete_url_name, instance_	id, popup_title, popup_id -->
		{% call general_popup(title="Delete",popup_id="delete_alert") %}
		<div class="modal-body">
			<h4>Are you sure, you want to delete this?</h4>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">No Go back</button>
			<a href="{{ url('onboarding:bu_delete', args=[buform.instance.id]) }}"
				class="btn btn-sm  btn-danger rounded-1">Yes I'm Sure</a>
		</div>
		{% endcall %}
	{% endif %}

	<!------------- typeassist popup for onclick + icon ---------------------->
	{% call general_popup(title='Create TypeAssist', popup_id = "butype_ta_popup") %}
	<form action="" method="post" id="butype_ta_form">
		<div class="modal-body">
			<input type="hidden" name="form_name" , value="ta_form">
			{% if ta_form is defined %}
			{{ typeassist_form() }}
			{% endif %}
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-sm  btn-secondary rounded-1" onclick="document.getElementById('butype_ta_form').reset()" data-bs-dismiss="modal">Close</button>
			<input type="submit" class="btn btn-sm  btn-primary rounded-1"  value="Sumbit" form="butype_ta_form" />
		</div>
	</form>
	{% endcall %}
{% endblock popup_alerts %}
<!------------------------  END POP-UPS CODE ----------------------------->

<!-- calling the macro form which is imported above -->





<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Buisiness-View
{% endblock form_title %}
<!------ END FORM TITLE -------->


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
{% if buform.non_field_errors() %}
<div id="non_field_error" class="alert alert-danger" style="width: 73%;">
	{% for error in buform.non_field_errors() %}
	{{ error }}
	{% endfor %}
	<button type="button" class="btn-close flt-right" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->


<!-------------- BEGIN FORM ------------------->
{% block form %}
<form action="" method="post" id="id_buform">
	<!-------------------------- CSRF MIDDLEWARE TOKEN --------------------->
	<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
	<input type="hidden" name="{{ buform.ctzoffset.name }}" id = "{{ buform.ctzoffset.auto_id }}" value="-1">

	<div class="mb-3 row g-3 gx-6">
		<!--BUCODE-->
		<label class="required col-form-label col-md-2 col-sm-2 text-sm-right" for="id_bucode">Code:
			<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
				data-bs-placement="top"
				title="Code is a unique name which is associated to all operations related to buisiness unit"
				style="vertical-align: middle; font-size: 19px;">
				info
			</span>
		</label>
		<div class="col-md-4">
			{{ buform.bucode }}
			{{ buform.bucode.errors }}
		</div>
		
		<!--BUNAME-->
		<label class="required col-form-label col-md-2 col-sm-2 text-sm-right" for="id_buname">Name:
			<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
				data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
				title="'Name' should be more readable compared to 'Code', spaces are allowed in this field">
				info
			</span>
		</label>
		<div class="col-md-4">
			{{ buform.buname }}
			{{ buform.buname.errors }}
		</div>
		<!--PARENT-->
		<label class="required col-form-label col-md-2 col-sm-2 text-sm-right" for="id_parent">Belongs to:
			<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
				data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
				title="As the name suggest it specifies, to which buisness unit it belongs to.">
				info
			</span>
		</label>
		<div class="col-md-4">
			{{ buform.parent }}
			{{ buform.parent.errors }}
		</div>
		
		<!--BU IDENTIFIER-->
		<label for="id_identifier" class="required col-form-label col-md-2 col-sm-2 text-sm-right">Type:
			<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
				data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
				title="Butype specfies the type of this buisiness unit">
				info
			</span>
		</label>
		<div class="col-md-4">
			<div class="d-flex flex-row">
				{{ buform.identifier }}
			</div>
			{{ buform.identifier.errors }}
		</div>
		<!--SITE TYPE-->
		<label for="id_butype" style="display:none;" class="col-form-label col-md-2 col-sm-2 text-sm-right site_type">Site Type:
			<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
				data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
				title="Butype specfies the type of this buisiness unit">
				info
			</span>
		</label>
		<div class="col-md-4 site_type" style="display:none;">
			<div class="d-flex flex-row">
				{{ buform.butype }}
				<a href="" type="button" data-bs-toggle="modal" data-bs-target="#butype_ta_popup"><span
						style="font-size: 24px;" data-bs-toggle="tooltip" data-bs-placement="left"
						title="If you haven't found an option in selection menu, then create one from here"
						class="material-icons-outlined mt-3 ps-2 primary-col">
						add_circle
					</span></a>
			</div>
			{{ buform.butype.errors }}
		</div>
		<!--GPS LOCATION-->
		<label for="id_gpslocation" class="col-form-label col-md-2 col-sm-2 text-sm-right">GPS Location:
			<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
				data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
				title="Longitude & latitude cordinates of the buisiness unit">
				info
			</span>
		</label>
		<div class="col-md-4">
			{{ buform.gpslocation }}
			{{ buform.gpslocation.errors }}
		</div>

		<!--------------------- BEGIN CHECKBOXES -------------------------->
		<div class="booleans col-md-6 d-flex justify-content-sm-between mt-5">
			<label for="{{ buform.iswarehouse.id_for_label }}"
				class="form-check-label bool col-form-label me-5 text-sm-right">
				{{ buform.iswarehouse }} &nbsp; {{ buform.iswarehouse.label }}
				<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
					data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
					title="Check,  if this buisiness unit is a warehouse">
					info
				</span>
			</label>

			<label for="{{ buform.isserviceprovider.id_for_label }}"
				class="form-check-label bool col-form-label me-5 text-sm-right">
				{{ buform.isserviceprovider }} &nbsp; {{ buform.isserviceprovider.label }}
				<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
					data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
					title="Check,  if this buisiness unit is a service provider">
					info
				</span>
			</label>

			<label for="{{ buform.isvendor.id_for_label }}"
				class="form-check-label bool col-form-label me-5 text-sm-right">
				{{ buform.isvendor }} &nbsp; {{ buform.isvendor.label }}
				<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
					data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
					title="Check,  if this buisiness unit is a vendor">
					info
				</span>
			</label>

			<label for="{{ buform.enable.id_for_label }}"
				class="form-check-label bool col-form-label me-5 text-sm-right">
				{{ buform.enable }} &nbsp; {{ buform.enable.label }}
				<span class="material-icons-outlined h-19px" data-bs-toggle="tooltip" data-bs-custom-class="tooltip"
					data-bs-placement="top" style="vertical-align: middle; font-size: 19px;"
					title="Uncheck if this buisiness unit not enabled">
					info
				</span>
			</label>
		</div>
		<!--------------------- END CHECKBOXES -------------------------->

	</div>
</form>
{% endblock form %}
<!------------- END FORM ---------------------->


<!-------------- BEGIN FORM PAGE ACTIONS --------->
{% block formpage_actions %}
{% if request.session['wizard_data'] is defined %}
<!--- BEGIN wizard Controls --->
{{ super() }}
<!-- END wizard Controls ------>
{% else %}
<!--- BEGIN Normal Form Controls -->
{% if edit is defined %}
{{ form_update('id_buform', popup_id="delete_alert") }}
{% else %}
{{ form_create('id_buform') }}
{% endif %}
<!----- END Normal Form Controls --->

{% endif %}
{% endblock formpage_actions %}
<!---------------- END FORM PAGE ACTIONS ----------->


<!--------------- BEGIN PAGE-LEVEL EXTRA SCRIPTS --------------->
{% block extra_scripts %}
{{ buform.media.js }}
<script>
	function showHideBuType(){
		//on load check butype is site
		var data = $("#id_identifier option:selected").text();
		var list = ['SITE', 'Site (SITE)', 'Site']
		if(list.includes(data)){
				$(".site_type").show();
		}else{$(".site_type").hide();}
	}
	$(document).ready(function () {
		//set ctzoffset
        $("#id_ctzoffset").val(-new Date().getTimezoneOffset())
		
		//hide the delete button when instance is not saved yet.
		if ('{{buform.instance.id}}' == 'None') {
			$("#btn_del").hide()
		}

		// submit the popup-taform for validation and saving in db.
		$('#butype_ta_form').on('submit', sumit_popup_form({
			'url': "{{ url('onboarding:ta_popup') }}",
			'form': "#butype_ta_form",
			'field': "#id_butype",
			'modal': "#butype_ta_popup",
			'default':$("#butype_ta_popup select option:contains('SITETYPE')").val()

		}))
		
		//for select2 search work in bootstrap modals
		$("#typeassist_popup").find("select[name=tatype]").select2({
            dropdownParent: $('#typeassist_popup')
        })
		
		$("#butype_ta_popup").find("select[name=tatype]").select2({
            dropdownParent: $('#butype_ta_popup')
        })
		
		//closeOnSelect set true 
		$('#id_parent, #id_butype').select2({
			closeOnSelect: true
		})
		
		//hide next btn if instance is not saved yet
		if (session['wizard_data'] && session['wizard_data']['bus'].length == 0) {
			$('#next_btn').hide()
		}
		//show butype when user opts to site
		$('#id_identifier').on('change', function() {
			console.log("changed")
			showHideBuType()
		})
		//pre-select options for pop-up ta forms
		$("#butype_ta_popup select[name='tatype']").val($("#butype_ta_popup select option:contains('SITETYPE')").val()).change()
		$("#butype_ta_popup select[name='tatype']").select2({disabled: 'readonly'})

		//on load check
		showHideBuType();
		
	})
</script>
{% endblock extra_scripts %}
<!--------------- END PAGE-LEVEL EXTRA SCRIPTS --------------->