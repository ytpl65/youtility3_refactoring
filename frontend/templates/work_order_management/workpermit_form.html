{% extends "base_form.html" %}

{% block extra_css %}
{{ wpform.media.css }}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
<link  href="{{ static('assets/plugins/custom/Editor-2.0.8/css/editor.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('work_order_management:work_permit') }}?template=true" class="pe-3">Work Permits</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">Work Permit Form</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Work Permit Form
{% endblock form_title %}
<!------ END FORM TITLE -------->

{% block ajax_page_actions %}
<div class="form-actions">
    {% if wpform.instance.id %}
    <button type="submit" id="submitTour" form="wpform" class="btn btn-sm btn-primary2 btn-hover-scale">
        Update &nbsp;<i class="fas text-white fa-cloud-upload-alt"></i>
    </button>

    <button type="button" onclick="deleteWorkpermit(this)" data-id="{{ wpform.instance.id }}" id="deleteAttd"
        class="btn btn-sm btn-danger btn-hover-scale">
        Delete&nbsp;<i class="fas text-white fa-trash-alt"></i>
    </button>
    {% else %}
    <button type="submit" form="wpform" class="btn btn-sm btn-primary2 btn-hover-scale">
        Save &nbsp;<i class="fas text-white fa-cloud-upload-alt"></i>
    </button>
    {% endif %}
</div>
{% endblock ajax_page_actions %}

{% block form %}
<form action="{{ url('work_order_management:work_permit') }}" method="post" id="wpform">
<!--------------------------CSRF MIDDLEWARE TOKEN---------------------->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <input type="hidden" name="{{ wpform.ctzoffset.name }}" id = "{{ wpform.ctzoffset.auto_id }}" value="-1">
    <input type="hidden" name="pk" id="pk" value="{{ wpform.instance.id }}">

    <div class="mb-3 row g-3 gx-6">
        <div class="col-md-6">
            <div class="input-group mb-3">
                <div class="col-md-4 col-sm-12 pt-2">
                {{ wpform.qset.label_tag() }}
                </div>
                <div class="col-md-8 col-sm-12 ">
                {{ wpform.qset }}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="input-group mb-3">
                <div class="col-md-4 col-sm-12 pt-2">
                {{ wpform.seqno.label_tag() }}
                </div>
                <div class="col-md-8 col-sm-12 ">
                {{ wpform.seqno }}
                </div>
            </div>
        </div>
    </div>




</form>
{% endblock form %}


{% block extras %}

{% endblock extras %}

{% block extra_scripts %}
{{ wpform.media.js }}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/DataTables/Select-1.3.4/js/dataTables.select.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.8/js/dataTables.editor.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.8/js/editor.select2.js') }}" type="text/javascript"></script>
<script>

    $(document).ready(function(){
        //set seqno once loaded
        $("#id_seqno").val("{{ wpform.instance.other_data['wp_seqno'] }}")

        const urlname = "{{ url('work_order_management:work_permit') }}"
        $("#wpform").submit((e) => {
            e.preventDefault()
            var form = $(this)
            const params = {
                url: $(form).attr("action"),
                modal: false
            }
            const formtype = '{{wpform.instance.id}}' == 'None' ? "create" : "update" //form-type (create/update)      
            var payLoad = {
                formData: $("#wpform").serialize(),
                csrfmiddlewaretoken: '{{ csrf_token }}',
                'uuid': "{{ ownerid }}"
            }

            if (formtype === 'update') {
                var newPayLoad = {
                ...payLoad,
                'pk': id
                }
                payLoad = newPayLoad
            }
            submit_form_alert().then((res) => {
                if (res.isConfirmed) {
                    fire_ajax_form_post(params, payLoad)
                    .done((data, status, xhr) => {
                        show_successful_save_alert(update= id != 'None' ? true : false)
                        window.setTimeout(function() {
                            window.location.href = `${urlname}?id=${data.pk}`;
                        }, 2000);
                    })
                    .fail((xhr, status, error) => {
                        console.log(xhr)
                        if (!typeof (xhr.responseJSON.errors) === 'object') {
                        show_error_alert(xhr.responseJSON.errors, "Failed to save!")
                        } else {}

                    })
                }

            })
        })
    })

</script>
{% endblock extra_scripts %}